<Document file="StarVMC/Geometry/FpdmGeo/FpdmGeo3.xml">

    <Module name="FPDMGEO3" comment=" is the Forward Pion Detector Modules GEOmetry "  >
        <Created date="   27 Nov 2006 "  />
        <Author name="Akio Ogawa"  />
        <CDE  >
            AGECOM
            GCONST
            GCUNIT
        </CDE>
        
        <Content  >
            FBOX,FTOW,FLXF,FWAL,FLGR,FPCT,FUMT,
            PBPT,FSHM,FHMS,FXGT,FALU,FBAS,FENC,
            FEAC,FEBC,FECC,FEDC,FETC,FERC,FESC, 
            FEEC
        </Content>
        
        <Structure name="FMCG"  >
            <var name="Version" type="float"  />
            <var name="ChkvSim" type="float"  />
            <var name="PbPlate" type="float"  />

            <var name="FmsNorthX" />
            <var name="FmsSouthX" />

        </Structure>

        
        <Structure name="FPOS"  >
            <var name="iMod"  type="float"  />
            <var name="iType" type="float"  />
            <var name="X"     type="float"  />
            <var name="Y"     type="float"  />
            <var name="Z"     type="float"  />
            <var name="AY"    type="float"  />
            <var name="AZ"    type="float"  />
        </Structure>


        
        <Structure name="FBXD"  >
            <var name="Type" type="float"  />
            <var name="Height" type="float"  />
            <var name="Depth" type="float"  />
            <var name="Width" type="float"  />
            <var name="NX" type="float"  />
            <var name="NY" type="float"  />
            <var name="NXL" type="float"  />
            <var name="NYL" type="float"  />
            <var name="XOffset" type="float"  />
            <var name="ZOffset" type="float"  />
            <var name="PSOffset" type="float"  />
            <var name="SmdOff" type="float"  />
        </Structure>
        
        <Structure name="FLGG"  >
            <var name="Type" type="float"  />
            <var name="Width" type="float"  />
            <var name="Depth" type="float"  />
            <var name="DGap" type="float"  />
            <var name="AlThick" type="float"  />
            <var name="PhCathDz" type="float"  />
            <var name="PhCathR" type="float"  />
            <var name="MuMetDz" type="float"  />
            <var name="MuMetR" type="float"  />
        </Structure>
        
        <Structure name="FLGM"  >
            <var name="Type" type="float"  />
            <var name="Density" type="float"  />
            <var name="RadLen" type="float"  />
            <var name="PbCont" type="float"  />
            <var name="CritEne" type="float"  />
            <var name="MoliereR" type="float"  />
        </Structure>
        
        <Structure name="PBPD"  >
            <var name="Z" type="float"  />
            <var name="Width" type="float"  />
            <var name="Height" type="float"  />
            <var name="Thick" type="float"  />
        </Structure>
        
        <Structure name="FMXG"  >
            <var name="Version" type="float"  />
            <var name="Sapex" type="float"  />
            <var name="Sbase" type="float"  />
            <var name="Sgap" type="float"  />
            <var name="NStrip" type="float"  />
            <var name="G10Width" type="float"  />
            <var name="G10hgt" type="float"  />
            <var name="G10Thick" type="float"  />
        </Structure>
        
        <Structure name="INSE"  >
            <var name="Width" type="float"  />
            <var name="Depth" type="float"  />
            <var name="Height" type="float"  />
            <var name="SheetDpt" type="float"  />
            <var name="HoleGap" type="float"  />
            <var name="HoleDepth" type="float"  />
            <var name="HoleHeight" type="float"  />
            <var name="GapDepth" type="float"  />
            <var name="GapHeight" type="float"  />
            <var name="GateDepth" type="float"  />
            <var name="Ra" type="float"  />
            <var name="Rb" type="float"  />
            <var name="Diam" type="float"  />
            <var name="RMax" type="float"  />
            <var name="GateGap" type="float"  />
        </Structure>
        

        <varlist type="INTEGER"  >
            ChkvSim,iMod,iType,Type,PbPlate
        </varlist>
        
        <varlist type="INTEGER"  >
            i,j,m,serN
        </varlist>
        

        <varlist type="REAL"  >
            xx,yy,zz,x1,y1,z1,ztot,rtot,wid,widx,widy,bwid,x0,widL
        </varlist>
        
        <varlist type="REAL"  >
            ztotsmd,wtotsmd,zsmd,zsmd2,wsmd
        </varlist>
        
        <varlist type="REAL"  >
            xsmdh,ysmdh,zsmdh,xsmdv,ysmdv,zsmdv
        </varlist>
        
        <varlist type="REAL"  >
            xlcOffSet,BZOffSet
        </varlist>
        
        <varlist type="REAL"  >
            basewidth,distancer,xoffFECC,xoffFEDC,xshift
        </varlist>
        
        <varlist type="REAL"  >
            xoffFENC,yoffFENC,zoffFENC,zoffFECC
        </varlist>
        

        <varlist type="REAL"  >
            tmp(7)
        </varlist>
        

        <varlist type="INTEGER"  >
            N
        </varlist>
        
        <Parameter name="N" value="12"  />

        <varlist type="REAL"  >
            E(N)
        </varlist>
        

        <varlist type="REAL"  >
            rindex_PbG(N)
        </varlist>
        
        <varlist type="REAL"  >
            rindex_SiRub(N)
        </varlist>
        
        <varlist type="REAL"  >
            rindex_PhCath(N)
        </varlist>
        
        <varlist type="REAL"  >
            rindex_Alm(N)
        </varlist>
        
        <varlist type="REAL"  >
            rindex_MuMet(N)
        </varlist>
        

        <varlist type="REAL"  >
            absco_PbG(N)
        </varlist>
        
        <varlist type="REAL"  >
            absco_SiRub(N)
        </varlist>
        
        <varlist type="REAL"  >
            absco_PhCath(N)
        </varlist>
        
        <varlist type="REAL"  >
            absco_Alm(N)
        </varlist>
        
        <varlist type="REAL"  >
            absco_MuMet(N)
        </varlist>
        

        <varlist type="REAL"  >
            effic_PhCath(N)
        </varlist>
        
        <varlist type="REAL"  >
            effic_all(N)
        </varlist>
        

        <External routine="FFPDSTEP"  />
        <External routine="FPCTSTEP"  />
        <Fill name="FMCG" comment="Fpd Calorimeter basic data"  >
            <var name="Version" value="8.0" comment=" Geometry version  "  />
            <var name="ChkvSim" value="0" comment=" = 0 dE, = 1 Cherenkov simulation for PbG "  />
            <var name="PbPlate" value="0" comment=" =0 no plate, =1 with plate "  />

            <var name="FmsNorthX" value="-0.3" comment="Default x-position" />
            <var name="FmsSouthX" value="+0.3" comment="Default x-position" />

        </Fill>

	<Use struct="FMCG" select="version" value="8.0" />

        
        <Fill name="FPOS" comment="Fpd EN positioning"  >
            <var name="iMod" value="1" comment=" Module# (EN=1, ES=2, WN=3, WS=4, ...) "  />
            <var name="iType" value="1" comment=" Type (1=7*7+SMD+PreShower, 2=17*34+14*28) "  />
            <var name="X" value="-48.19" comment=" X distance from beam to edge of detector "  />
            <var name="Y" value="0.0" comment=" Y distance from beam to edge of detector "  />
            <var name="Z" value="-779.0" comment=" Z distance from IP to surface of detector "  />
            <var name="AY" value="180" comment=" Angle aroound Y (0 for west, 180 for east) "  />
            <var name="AZ" value="0" comment=" Angle around Z "  />
        </Fill>
        
        <Fill name="FPOS" comment="Fpd ES positioning"  >
            <var name="iMod" value="2" comment=" Module# (EN=1, ES=2, WS=3, WS=4, ...) "  />
            <var name="iType" value="1" comment=" Type (1=7*7+SMD+PreShower, 2=17*34+14*28) "  />
            <var name="X" value="48.19" comment=" X distance from beam to edge of detector "  />
            <var name="Y" value="0.0" comment=" Y distance from beam to edge of detector "  />
            <var name="Z" value="-779.0" comment=" Z distance from IP to surface of detector "  />
            <var name="AY" value="180" comment=" Angle aroound Y (0 for west, 180 for east) "  />
            <var name="AZ" value="0" comment=" Angle around Z "  />
        </Fill>
        

        <Fill name="FPOS" comment="FMS WN positioning"  >
            <var name="iMod"  value="3" comment=" Module# (EN=1, ES=2, WN=3, WS=4, ...) "  />
            <var name="iType" value="2" comment=" Type (1=7*7+SMD+PreShower, 2=17*34+14*28) "  />
            <var name="X"     value="FMCG_FmsNorthX" comment=" X distance from beam to edge of detector "  />
            <var name="Y"     value="0.0" comment=" Y distance from beam to edge of detector "  />
            <var name="Z"     value="706.3" comment=" Z distance from IP to surface of detector "  />
            <var name="AY"    value="0" comment=" Angle aroound Y (0 for west, 180 for east) "  />
        </Fill>
        

        <Fill name="FPOS" comment="FMS WS positioning"  >
            <var name="iMod"  value="4" comment=" Module# (EN=1, ES=2, WN=3, WS=4, ...) "  />
            <var name="iType" value="2" comment=" Type (1=7*7+SMD+PreShower, 2=17*34+14*28) "  />
            <var name="X"     value="FMCG_FmsSouthX" comment=" X distance from beam to edge of detector "  />
            <var name="Y"     value="0.0" comment=" Y distance from beam to edge of detector "  />
            <var name="Z"     value="706.3" comment=" Z distance from IP to surface of detector "  />
            <var name="AY"    value="0" comment=" Angle aroound Y (0 for west, 180 for east) "  />
            <var name="AZ"    value="0" comment=" Angle around Z "  />
        </Fill>
        
        <Fill name="FBXD" comment="FPD Box Geometry"  >
            <var name="Type" value="1" comment=" Type (1=7*7+SMD+PreShower, 2=17*34+14*28) "  />
            <var name="Height" value="100" comment=" Box height "  />
            <var name="Depth" value="96" comment=" Box Depth "  />
            <var name="Width" value="0.0" comment=" Box Width (only for FMS) "  />
            <var name="NX" value="7" comment=" Number of pbg in x "  />
            <var name="NY" value="7" comment=" number of pbg in y "  />
            <var name="NXL" value="0" comment=" Number of large pbg in x "  />
            <var name="NYL" value="0" comment=" number of large pbg in y "  />
            <var name="XOffset" value="2.54" comment=" tower x offset from box edge to PbG edge "  />
            <var name="ZOffset" value="19" comment=" tower z offset from box edge to PbG edge       "  />
            <var name="PSOffset" value="2.0" comment=" PreShower z offset from box edge to PbG edge "  />
            <var name="SmdOff" value="8.0" comment=" SMD V-plane z offset from box edge "  />
        </Fill>
        

        <Fill name="FBXD" comment="FPD Box Geometry"  >
            <var name="Type" value="2" comment=" Type (1=7*7+SMD+PreShower, 2=17*34+14*28) "  />
            <var name="Height" value="210" comment=" Box height "  />
            <var name="Depth" value="98.425" comment=" Box Depth "  />
            <var name="Width" value="127.0" comment=" Box Width (only for FMS) "  />
            <var name="NX" value="12" comment=" Number of pbg in x "  />
            <var name="NY" value="24" comment=" number of pbg in y "  />
            <var name="NXL" value="17" comment=" Number of large pbg in x "  />
            <var name="NYL" value="34" comment=" number of large pbg in y "  />
            <var name="XOffset" value="(6*3.822+0.5*5.812)+(127.0-17*5.812)/2.0" comment=" tower x offset from box edge to PbG edge "  />
            <var name="ZOffset" value="10.4" comment=" tower z offset from box edge to PbG edge "  />
            <var name="PSOffset" value="0" comment=" PreShower z offset from box edge to PbG edge "  />
            <var name="SmdOff" value="0.0" comment=" SMD z offset from box edge "  />
        </Fill>
        


        <Fill name="FLGG" comment="PbG detector geometry"  >
            <var name="Type" value="1" comment=" Type (1=Protovino Cell, 2=FLab Cell) "  />
            <var name="Width" value="3.81" comment=" PbG width  "  />
            <var name="Depth" value="45.0" comment=" PbG depth "  />
            <var name="DGap" value="0.01" comment=" Gap between PbG "  />
            <var name="AlThick" value="0.001" comment=" almunim wrap thickness (real) "  />
            <var name="PhCathDz" value="2.0" comment=" Photo Cathode thickness "  />
            <var name="PhCathR" value="1.8" comment=" Photo Cathode radius  (real) "  />
            <var name="MuMetDz" value="11.0" comment=" Mu Metal Length "  />
            <var name="MuMetR" value="1.9" comment=" Mu metal outer Radius  (real) "  />
        </Fill>
        
        <Fill name="FLGG" comment="PbG detector geometry"  >
            <var name="Type" value="2" comment=" Type (1=Protovino Cell, 2=FLab Cell) "  />
            <var name="Width" value="5.8" comment=" PbG width  "  />
            <var name="Depth" value="60.2" comment=" PbG depth "  />
            <var name="DGap" value="0.01" comment=" Gap between PbG "  />
            <var name="AlThick" value="0.001" comment=" almunim wrap thickness (real) "  />
            <var name="PhCathDz" value="2.0" comment=" Photo Cathode thickness "  />
            <var name="PhCathR" value="1.8" comment=" Photo Cathode radius  (real) "  />
            <var name="MuMetDz" value="11.0" comment=" Mu Metal Length "  />
            <var name="MuMetR" value="1.9" comment=" Mu metal outer Radius  (real) "  />
        </Fill>
        
        <Fill name="FLGM" comment="PbG detector materials"  >
            <var name="Type" value="1" comment=" Type (1=Protovino Cell, 2=FLab Cell) "  />
            <var name="Density" value="3.86" comment=" gdensity [/cm^3] "  />
            <var name="RadLen" value="2.5" comment=" radiation length [cm] "  />
            <var name="PbCont" value="65.4" comment=" PbO content [%] "  />
            <var name="CritEne" value="0.0158" comment=" critical energy [GeV] "  />
            <var name="MoliereR" value="3.32" comment=" Moliere radius [cm] "  />
        </Fill>
        
        <Fill name="FLGM" comment="PbG detector materials"  >
            <var name="Type" value="2" comment=" Type (1=Protovino Cell, 2=FLab Cell) "  />
            <var name="Density" value="3.61" comment=" gdensity [/cm^3] "  />
            <var name="RadLen" value="3.21" comment=" radiation length [cm] "  />
            <var name="PbCont" value="45.0" comment=" PbO content [%] "  />
        </Fill>
        
        <Fill name="PBPD" comment="Pb Plate dimensions"  >
            <var name="Width" value="33.02" comment=" Width "  />
            <var name="Height" value="33.02" comment=" Height "  />
            <var name="Thick" value="1.27" comment=" Thickness "  />
        </Fill>
        
        <Fill name="FMXG" comment="SMD geometry"  >
            <var name="Version" value="2" comment=" Geometry version "  />
            <var name="Sapex" value="0.7" comment=" Scintillator strip apex "  />
            <var name="Sbase" value="1.0" comment=" Scintillator strip base "  />
            <var name="Sgap" value="0.0064" comment=" Gap between strips "  />
            <var name="NStrip" value="50" comment=" # of strips "  />
            <var name="G10Width" value="27.0" comment=" G10 plate width "  />
            <var name="G10hgt" value="27.0" comment=" G10 plate height "  />
            <var name="G10Thick" value="0.15" comment=" G10 plate thickness "  />
        </Fill>
        
        <Fill name="INSE" comment="INSERT geometry"  >
            <var name="Width" value="19.30908" comment=" Width of the insert (x) "  />
            <var name="Depth" value="98.425" comment=" Depth of the insert (z) "  />
            <var name="Height" value="38.608" comment=" Height of the insert (y)   "  />
            <var name="SheetDpt" value="1.27" comment=" Depth of the steel parts (x,y) "  />
            <var name="HoleGap" value="5.08" comment=" Distance between edge of INSERT and square hole "  />
            <var name="HoleDepth" value="25.4" comment=" Depth of the square hole (z) "  />
            <var name="HoleHeight" value="30.48" comment=" Height of the square hole (y) "  />
            <var name="GapDepth" value="19.685" comment=" Depth of the iron distancer (z) "  />
            <var name="GapHeight" value="7.874" comment=" Height of the iron distancer (y) "  />
            <var name="GateDepth" value="1.905" comment=" Depth of one of the three Gates (z) "  />
            <var name="GateGap" value="12.7" comment=" Distance between the back edge of the box and last gate "  />
            <var name="Ra" value="13.97" comment=" Radius of the inner circle of tubes "  />
            <var name="Rb" value="20.6375" comment=" Radius of the outer circle of tubes  "  />
            <var name="Diam" value="6.0325" comment=" Diameter of the tubes "  />
            <var name="RMax" value="10.16" comment=" Radius of the inner tube for beampipe "  />
        </Fill>
        

        <Use struct="FMCG"  />

        <Print level="1" fmt="'****************** FPDMGEO version ', F4.2"  >
            fmcg_version
        </Print>
        
        <Do var="m" from="1" to="4"  >

            <Use struct="FPOS" select="iMod" value="m "  />
            <Use struct="FBXD" select="Type" value="FPOS_iType "  />

            <If expr="FBXD_Type.eq.1"  >
                <Use struct="FLGG" select="Type" value="1 "  />
                wid  =  FLGG_Width + FLGG_DGap + FLGG_AlThick*2.0 
                ztot = (FLGG_Depth + FLGG_AlThick + FLGG_MuMetDz)/2.0 
                rtot = FBXD_NX*wid/2.0         
                bwid = rtot+FBXD_XOffset 
                <Else  >
                    <Use struct="FLGG" select="Type" value="2 "  />
                    wid  =  FLGG_Width + FLGG_DGap + FLGG_AlThick*2.0 
                    ztot = (FLGG_Depth + FLGG_AlThick + FLGG_MuMetDz)/2.0 
                    rtot = FBXD_NXL*wid/2.0         
                    bwid = rtot 
                </Else>
                
            </If>
            

            <If expr="m.ge.3"  >
                bwid=FBXD_Width/2.0  
                <If expr="FPOS_X.gt.0.0"  >
                    xx=FPOS_X+bwid  
                    <Elif expr="FPOS_X.eq.0.0"  >
                        xx=0.0 
                    </Elif>
                    
                    <Else  >
                        xx=FPOS_X-bwid 
                    </Else>
                    
                </If>
                
                <Else  >
                    <If expr="FPOS_X.gt.0.0"  >
                        xx=FPOS_X+bwid 
                        <Elif expr="FPOS_X.eq.0.0"  >
                            xx=0.0 
                        </Elif>
                        
                        <Else  >
                            xx=FPOS_X-bwid 
                        </Else>
                        
                    </If>
                    
                </Else>
                
            </If>
            

            <If expr="FPOS_Y.gt.0.0"  >
                yy=FPOS_Y+FBXD_Height/2.0 
                <Elif expr="FPOS_Y.eq.0.0"  >
                    yy=0.0 
                </Elif>
                
                <Else  >
                    yy=FPOS_Y-FBXD_Height/2.0 
                </Else>
                
            </If>
            

            <If expr="FPOS_Z.gt.0.0"  >
                zz=FPOS_Z+FBXD_Depth/2.0 
                <Else  >
                    zz=FPOS_Z-FBXD_Depth/2.0 
                </Else>
                
            </If>
            

            serN=0 

            <If expr="m.eq.4"  >
                serN=1 
            </If>
            
            <If expr="m.ne.7"  >
                <Create block="FBOX"  />
                <Placement in="CAVE" y="yy" x="xx" z="zz" konly="'MANY'" block="FBOX"  >
                    <Rotation alphay="FPOS_AY"  />
                </Placement>
                
            </If>
            
        </Do>
        

        <Block name="FBOX" comment="is one Pb-Glass fpd detector"  >
            <Material name="Air"  />
            <Medium name="standard"  />
            <Attribute for="FBOX" seen="1" serial="serN" colo="2"  />
            <If expr="FBXD_Type.eq.2"  >
                <Shape type="BOX" dz="FBXD_Depth/2.0" dx="FBXD_Width/2.0" dy="FBXD_Height/2.0"  />
                <Else  >
                    <Shape type="BOX" dz="FBXD_Depth/2.0" dx="bwid" dy="FBXD_Height/2.0"  />
                </Else>
                
            </If>
            

            <Use struct="FLGG" select="Type" value="2 "  />
            widL = FLGG_Width + FLGG_DGap + FLGG_AlThick*2.0              !large cell width 
            <Use struct="FLGG" select="Type" value="1 "  />
            <Use struct="FLGM" select="Type" value="1 "  />
            wid  =  FLGG_Width + FLGG_DGap + FLGG_AlThick*2.0             !small cell width 
            ztot = (FLGG_Depth + FLGG_AlThick + FLGG_MuMetDz)/2.0        
            rtot = FBXD_NX*wid/2.0 
            bwid = rtot-FBXD_XOffset 

            <Create block="FTOW"  />
            <Create block="PBPT"  />
            <Create block="FSHM"  />

            <If expr="FBXD_Type.eq.2.and.FPOS_iMod.eq.4"  >
                x0 = - rtot - FBXD_XOffset + wid/2.0                        ! x0 start from north (near beam) for  
                widx = wid                                                ! WS (FMS-south) module 
                <Else  >
                    x0 =  rtot + FBXD_XOffset - wid/2.0                         ! x0 start from south for north/top/bottom module 
                    widx = -wid                                               ! since fpd is symmetric, true for ES module too 
                </Else>
                
            </If>
            
            <If expr="FBXD_Type.eq.2"  >
                y1 =  FBXD_NY*wid/2.0 - wid/2.0 + (16*widL-FBXD_NY*wid)/2.0   !in order to correct the differences between   
                widy = wid+(16.0*widL-FBXD_NY*wid)/23.0                       !3 small cells and 2 large ones (see again in 17 lines)   
                <Else  >
                    y1 =  FBXD_NY*wid/2.0 - wid/2.0                           
                    widy = wid 
                </Else>
                
            </If>
            
            z1 = -FBXD_Depth/2.0 + FBXD_ZOffset + ztot 
            <Do var="i" from="1" to="FBXD_NY"  >
                x1=x0 
                <Do var="j" from="1" to="FBXD_NX"  >
                    <If expr="FBXD_Type.eq.2.and.j.lt.6.and.i.gt.7.and.i.lt.18"  >
                        x1=x1+widx 
                        <Else  >
                            <Create block="FTOW"  />
                            <Placement y="y1" x="x1" z="z1" block="FTOW"  >
                            </Placement>
                            
                            x1=x1+widx 
                        </Else>
                        
                    </If>
                    
                </Do>
                
                y1 =  y1-widy 
            </Do>
            
            <If expr="FBXD_Type.eq.1"  >
                x1=x0 
                y1= -rtot + ztot 
                z1=-FBXD_Depth/2.0  + FBXD_PSOffset + wid/2.0 
                <Do var="j" from="1" to="FBXD_NX"  >
                    <Create block="FTOW"  />
                    <Placement y="y1" x="x1" z="z1" block="FTOW"  >
                        <Rotation alphax="90"  />
                    </Placement>
                    
                    x1=x1-wid 
                </Do>
                
                <If expr="fmcg_PbPlate==1"  >
                    <Create block="PBPT"  />
                    <Placement y="0" x="0" z="PBPD_Thick/2.0-FBXD_Depth/2.0" block="PBPT"  >
                    </Placement>
                    
                </If>
                
                ztotsmd=FMXG_G10Thick+FMXG_Sapex 
                <Create block="FSHM"  />
                <Placement y="0" x="0" z="FBXD_SmdOff+ztotsmd-FBXD_Depth/2.0" block="FSHM"  >
                </Placement>
                
            </If>
            

            <If expr="FBXD_Type.ge.2"  >
                <Use struct="FLGG" select="Type" value="2 "  />
                <Use struct="FLGM" select="Type" value="2 "  />
                wid  = FLGG_Width + FLGG_DGap +  FLGG_AlThick*2.0 
                ztot = FLGG_Depth/2.0 
                rtot = FBXD_NXL*wid/2.0 
                bwid = rtot 
                xlcOffSet = (FBXD_Width-FBXD_NXL*wid)/2.0          ! Large Cells OffSet in X 
                <If expr="FPOS_iMod.eq.4"  >
                    x0 =  -bwid + wid/2.0 - xlcOffSet 
                    widx = wid 
                    <Elif expr="FPOS_iMod.eq.3"  >
                        x0 =  +bwid - wid/2.0 + xlcOffSet  
                        widx = -wid 
                    </Elif>
                    
                </If>
                
                y1 =  FBXD_NYL*wid/2.0 - wid/2.0 
                z1 = -FBXD_Depth/2.0 + FBXD_ZOffset + ztot 
                <Do var="i" from="1" to="FBXD_NYL"  >
                    x1=x0             
                    <Do var="j" from="1" to="FBXD_NXL"  >
                        <If expr="j.lt.9.and.i.gt.9.and.i.lt.26"  >
                            x1=x1+widx  
                            <Elif expr="(i+j).ge.45"  >
                                <Create block="FALU"  />
                                <Placement y="y1" x="x1" z="z1" block="FALU"  >
                                </Placement>
                                
                                x1=x1+widx      
                                <Elif expr="(j-i).ge.10"  >
                                    x1=x1+widx             
                                </Elif>
                                
                                <Else  >
                                    <Create block="FLXF"  />
                                    <Placement y="y1" x="x1" z="z1" block="FLXF"  >
                                    </Placement>
                                    
                                    x1=x1+widx 
                                </Else>
                                
                            </Elif>
                            
                        </If>
                        
                    </Do>
                    
                    y1=y1-wid            
                </Do>
                
            </If>
            

            <If expr="FBXD_Type.eq.2"  >
                <Use struct="FLGG" select="Type" value="2 "  />
                <Use struct="FLGM" select="Type" value="2 "  />
                BZOffSet=0.0 
                wid  = FLGG_Width + FLGG_DGap  

                <Create    block="FBAS" />
                <Placement block="FBAS" y="-(FBXD_NXL*wid+basewidth/2.0)" x="FPOS_X" z="-FBXD_Depth/2.0+BZOffSet+INSE_Depth/2.0"/>
                
            </If>
            

            <Create block="FENC"  />
            <Create block="FEAC"  />
            <Create block="FECC"  />
            <Create block="FEDC"  />
            <Create block="FEEC"  />
            distancer=INSE_GapHeight-(INSE_Height-2.0*INSE_SheetDpt) 
            xoffFECC=(INSE_SheetDpt-FBXD_Width)/2.0 
            zoffFECC=-FBXD_Depth/2.0+BZOffSet+INSE_Depth-INSE_GateGap 
            xoffFEDC=INSE_Width - INSE_SheetDpt 
            xoffFENC=(INSE_Width-FBXD_Width)/2.0 
            yoffFENC=(INSE_Height-INSE_SheetDpt)/2.0 
            zoffFENC=-FBXD_Depth/2.0 + BZOffSet + INSE_Depth/2.0 
            xshift=8*5.812-12*3.822+5*3.822-INSE_Width    !this is to move insert to small cell edge 
            <If expr="FBXD_Type.eq.2"  >
                <If expr="FPOS_iMod.eq.4"  >

                    <Placement y="-yoffFENC" x="xoffFENC+xshift" z="zoffFENC" block="FENC"  >
                    </Placement>
                    
                    <Placement y="yoffFENC" x="xoffFENC+xshift" z="zoffFENC" block="FENC"  >
                    </Placement>
                    
                    <Placement y="0" x="INSE_Width+xshift-(FBXD_Width+INSE_SheetDpt)/2.0" z="-FBXD_Depth/2.0+BZOffSet+INSE_Depth/2.0" block="FEAC"  >
                    </Placement>
                    
                    <Placement y="distancer/2.0" x="xoffFECC+xshift" z="zoffFECC-INSE_GateDepth-INSE_GapDepth/2.0" block="FECC"  >
                    </Placement>
                    
                    <Placement y="distancer/2.0" x="xoffFECC+xshift" z="zoffFECC-2.0*INSE_GateDepth-3.0*INSE_GapDepth/2.0" block="FECC"  >
                    </Placement>
                    
                    <Placement y="-distancer/2.0" x="xoffFECC+xshift" z="zoffFECC-INSE_GateDepth-INSE_GapDepth/2.0" block="FECC"  >
                    </Placement>
                    
                    <Placement y="-distancer/2.0" x="xoffFECC+xshift" z="zoffFECC-2.0*INSE_GateDepth-3.0*INSE_GapDepth/2.0" block="FECC"  >
                    </Placement>
                    
                    <Placement y="0" x="xshift+(xoffFEDC-FBXD_Width)/2.0" z="zoffFECC-INSE_GateDepth/2.0" block="FEDC"  >
                    </Placement>
                    
                    <Placement y="0" x="xshift+(xoffFEDC-FBXD_Width)/2.0" z="zoffFECC-INSE_GateDepth-INSE_GapDepth-INSE_GateDepth/2.0" block="FEDC"  >
                    </Placement>
                    
                    <Placement y="0" x="xshift+(xoffFEDC-FBXD_Width)/2.0" z="zoffFECC-2.0*(INSE_GateDepth+INSE_GapDepth)-INSE_GateDepth/2.0" block="FEDC"  >
                    </Placement>
                    

                    <Elif expr="FPOS_iMod.eq.3"  >

                        <Placement y="-yoffFENC" x="-xoffFENC-xshift" z="zoffFENC" block="FENC"  >
                        </Placement>
                        
                        <Placement y="yoffFENC" x="-xoffFENC-xshift" z="zoffFENC" block="FENC"  >
                        </Placement>
                        
                        <Placement y="0" x="-xshift-INSE_Width+(FBXD_Width+INSE_SheetDpt)/2.0" z="-FBXD_Depth/2.0+BZOffSet+INSE_Depth/2.0" block="FEAC"  >
                        </Placement>
                        
                        <Placement y="distancer/2.0" x="-xoffFECC-xshift" z="zoffFECC-INSE_GateDepth-INSE_GapDepth/2.0" block="FECC"  >
                        </Placement>
                        
                        <Placement y="distancer/2.0" x="-xoffFECC-xshift" z="zoffFECC-2.0*INSE_GateDepth-3.0*INSE_GapDepth/2.0" block="FECC"  >
                        </Placement>
                        
                        <Placement y="-distancer/2.0" x="-xoffFECC-xshift" z="zoffFECC-INSE_GateDepth-INSE_GapDepth/2.0" block="FECC"  >
                        </Placement>
                        
                        <Placement y="-distancer/2.0" x="-xoffFECC-xshift" z="zoffFECC-2.0*INSE_GateDepth-3.0*INSE_GapDepth/2.0" block="FECC"  >
                        </Placement>
                        
                        <Placement y="0" x="-xshift-(xoffFEDC-FBXD_Width)/2.0" z="zoffFECC-INSE_GateDepth/2.0" block="FEEC"  >
                        </Placement>
                        
                        <Placement y="0" x="-xshift-(xoffFEDC-FBXD_Width)/2.0" z="zoffFECC-INSE_GateDepth-INSE_GapDepth-INSE_GateDepth/2.0" block="FEEC"  >
                        </Placement>
                        
                        <Placement y="0" x="-xshift-(xoffFEDC-FBXD_Width)/2.0" z="zoffFECC-2.0*(INSE_GateDepth+INSE_GapDepth)-INSE_GateDepth/2.0" block="FEEC"  >
                        </Placement>
                        
                    </Elif>
                    
                </If>
                
            </If>
            
        </Block>
        
        <Block name="FTOW" comment="is one PbG Tower"  >
            <Material name="Air"  />
            <Attribute for="FTOW" seen="1" colo="2"  />
            <Shape type="BOX" dz="ztot" dx="wid/2.0" dy="wid/2.0"  />

            <Create block="FWAL"  />
            <Placement z="-ztot+(FLGG_AlThick+FLGG_depth)/2.0" block="FWAL"  >
            </Placement>
            
            <Create block="FUMT"  />
            <Placement z="-ztot+FLGG_AlThick+FLGG_depth+FLGG_MuMetDz/2.0" block="FUMT"  >
            </Placement>
            
            <Create block="FPCT"  />
            <Placement z="-ztot+FLGG_AlThick+FLGG_depth+FLGG_PhCathDz/2.0" block="FPCT"  >
            </Placement>
            
        </Block>
        
        <Block name="FWAL" comment="is almunum wrapper"  >
            <Material name="Aluminium"  />
            <Attribute for="FWAL" seen="1" colo="3"  />
            <Shape type="BOX" dz="FLGG_Depth/2.0+FLGG_AlThick/2.0" dx="FLGG_Width/2.0+FLGG_AlThick" dy="FLGG_Width/2.0+FLGG_AlThick"  />
            <If expr="fmcg_ChkvSim==1"  >
                <Call expr="%Imed,N,E,ABSCO_Alm,EFFIC_all,RINDEX_Alm" routine="GSCKOV"  />
            </If>
            
            <Create block="FLGR"  />
            <Placement z="+FLGG_AlThick/2.0" block="FLGR"  >
            </Placement>
            
        </Block>
        
        <Block name="FLGR" comment="is Lead Glass detector"  >
            <Mixture name="PbG" dens="FLGM_Density" radl="FLGM_RadLen"  >
                <Component name="Pb" a="207.19" z="82" w=".60712"  />
                <Component name="K" a="39.102" z="19" w=".02324"  />
                <Component name="Si" a="28.088" z="14" w=".14771"  />
                <Component name="O" a="15.999" z="8" w=".22041"  />
                <Component name="As" a="74.922" z="33" w=".00152"  />
            </Mixture>
            
            <Medium name="leadglass" isvol="1 "  />
            <Attribute for="FLGR" seen="1" colo="4"  />
            <Shape type="BOX" dz="FLGG_depth/2.0" dx="FLGG_Width/2.0" dy="FLGG_Width/2.0"  />

            <Instrument block="FLGR">
            <Hit meas="elos" nbits="0" min="0" max="50" />
            </Instrument>

            <If expr="FMCG_ChkvSim==1"  >
                <Call expr="%Imed,N,E,ABSCO_PbG,EFFIC_All,RINDEX_PbG" routine="GSCKOV"  />
            </If>
            
        </Block>
        
        <Block name="FLXF" comment="is Lead Glass detector"  >
            <Mixture name="F2" dens="FLGM_Density" radl="FLGM_RadLen"  >
                <Component name="Pb" a="207.19" z="82" w=".41774"  />
                <Component name="K" a="39.102" z="19" w=".04151"  />
                <Component name="Si" a="28.088" z="14" w=".21047"  />
                <Component name="O" a="15.999" z="8" w=".29330"  />
                <Component name="Na" a="22.990" z="11" w=".03710"  />
            </Mixture>
            
            <Medium name="leadglass" isvol="1 "  />
            <Attribute for="FLXF" seen="1" colo="4"  />
            <Shape type="BOX" dz="FLGG_depth/2.0" dx="FLGG_Width/2.0" dy="FLGG_Width/2.0"  />
            <Instrument block="FLXF">
               <Hit meas="elos" nbits="0" min="0" max="50" />
            </Instrument>
        </Block>
        
        <Block name="FALU" comment="is Aluminium Base Cell"  >
            <Material name="Aluminium"  />
            <Attribute for="FALU" seen="1" colo="1"  />
            <Shape type="BOX" dz="FLGG_depth/2.0" dx="FLGG_Width/2.0" dy="FLGG_Width/2.0"  />
        </Block>

        <Block name="FBAS" comment="is Steel Base Plate"  >
            <Material name="Iron"  />
            <Attribute for="FBAS" seen="1" colo="1"  />
            <!-- ============================================================= -->
            <!-- basewidth is not initialized anywhere in original AgSTAR file -->
            <!-- ============================================================= -->
            <Shape type="BOX" dx="FBXD_Width/2.0" 
                              dy="basewidth/2.0" 
                              dz="INSE_Depth/2.0" />
            <!-- ============================================================= -->
        </Block>
        
        <Block name="FENC" comment="is Steel Enclosure"  >
            <Material name="Iron"  />
            <Attribute for="FENC" seen="1" colo="5"  />
            <Shape type="BOX" dz="INSE_Depth/2.0" dx="INSE_Width/2.0" dy="INSE_SheetDpt/2.0"  />
        </Block>
        

        <Block name="FEAC" comment="is Steel Enclosure"  >
            <Material name="Iron"  />
            <Attribute for="FEAC" seen="1" colo="5"  />
            <Shape type="BOX" dz="INSE_Depth/2.0" dx="INSE_SheetDpt/2.0" dy="(INSE_Height-2.0*INSE_SheetDpt)/2.0"  />
            <Create block="FEBC"  />
            <Placement y="0" x="0.0" z="-INSE_Depth/2.0+INSE_HoleDepth/2.0+INSE_HoleGap" block="FEBC"  >
            </Placement>
            

        </Block>
        

        <Block name="FEBC" comment="is Air square hole"  >
            <Material name="Air"  />
            <Attribute for="FEBC" seen="1" colo="5"  />
            <Shape type="BOX" dz="INSE_HoleDepth/2.0" dx="INSE_SheetDpt/2.0" dy="INSE_HoleHeight/2.0"  />
        </Block>
        

        <Block name="FECC" comment="is Steel distancer"  >
            <Material name="Iron"  />
            <Attribute for="FECC" seen="1" colo="5"  />
            <Shape type="BOX" dz="INSE_GapDepth/2.0" dx="INSE_SheetDpt/2.0" dy="INSE_GapHeight/2.0"  />
        </Block>
        

        <Block name="FEDC" comment="is Steel Enclosure part on south"  >
            <Material name="Iron"  />
            <Attribute for="FEDC" seen="1" colo="5"  />
            <Shape type="BOX" dz="INSE_GateDepth/2.0" dx="(xoffFEDC)/2.0" dy="(INSE_Height-2.0*INSE_SheetDpt)/2.0"  />
            <Create block="FERC"  />
            <Placement y="0" x="-(xoffFEDC)/2.0" z="0.0" block="FERC"  >
            </Placement>
            
            <Create block="FESC"  />
            <Placement y="INSE_Ra*sin(PI*5.0/12.0)" x="-(xoffFEDC)/2.0+INSE_Ra*cos(PI*5.0/12.0)" z="0.0" block="FESC"  >
            </Placement>
            
            <Placement y="INSE_Ra*sin(PI/4.0)" x="-(xoffFEDC)/2.0+INSE_Ra*cos(PI/4.0)" z="0.0" block="FESC"  >
            </Placement>
            
            <Placement y="INSE_Ra*sin(PI/12.0)" x="-(xoffFEDC)/2.0+INSE_Ra*cos(PI/12.0)" z="0.0" block="FESC"  >
            </Placement>
            
            <Placement y="-INSE_Ra*sin(PI/12.0)" x="-(xoffFEDC)/2.0+INSE_Ra*cos(PI/12.0)" z="0.0" block="FESC"  >
            </Placement>
            
            <Placement y="-INSE_Ra*sin(PI/4.0)" x="-(xoffFEDC)/2.0+INSE_Ra*cos(PI/4.0)" z="0.0" block="FESC"  >
            </Placement>
            
            <Placement y="-INSE_Ra*sin(PI*5.0/12.0)" x="-(xoffFEDC)/2.0+INSE_Ra*cos(PI*5.0/12.0)" z="0.0" block="FESC"  >
            </Placement>
            
            <Placement y="INSE_Rb*sin(PI/4.0)" x="-(xoffFEDC)/2.0+INSE_Rb*cos(PI/4.0)" z="0.0" block="FESC"  >
            </Placement>
            
            <Placement y="-INSE_Rb*sin(PI/4.0)" x="-(xoffFEDC)/2.0+INSE_Rb*cos(PI/4.0)" z="0.0" block="FESC"  >
            </Placement>
            
        </Block>
        

        <Block name="FEEC" comment="is Steel Enclosure part on north"  >
            <Material name="Iron"  />
            <Attribute for="FEEC" seen="1" colo="5"  />
            <Shape type="BOX" dz="INSE_GateDepth/2.0" dx="(xoffFEDC)/2.0" dy="(INSE_Height-2.0*INSE_SheetDpt)/2.0"  />
            <Create block="FETC"  />
            <Placement y="0" x="(xoffFEDC)/2.0" z="0.0" block="FETC"  >
            </Placement>
            
            <Create block="FESC"  />
            <Placement y="INSE_Ra*sin(PI*5.0/12.0)" x="(xoffFEDC)/2.0-INSE_Ra*cos(PI*5.0/12.0)" z="0.0" block="FESC"  >
            </Placement>
            
            <Placement y="INSE_Ra*sin(PI/4.0)" x="(xoffFEDC)/2.0-INSE_Ra*cos(PI/4.0)" z="0.0" block="FESC"  >
            </Placement>
            
            <Placement y="INSE_Ra*sin(PI/12.0)" x="(xoffFEDC)/2.0-INSE_Ra*cos(PI/12.0)" z="0.0" block="FESC"  >
            </Placement>
            
            <Placement y="-INSE_Ra*sin(PI/12.0)" x="(xoffFEDC)/2.0-INSE_Ra*cos(PI/12.0)" z="0.0" block="FESC"  >
            </Placement>
            
            <Placement y="-INSE_Ra*sin(PI/4.0)" x="(xoffFEDC)/2.0-INSE_Ra*cos(PI/4.0)" z="0.0" block="FESC"  >
            </Placement>
            
            <Placement y="-INSE_Ra*sin(PI*5.0/12.0)" x="(xoffFEDC)/2.0-INSE_Ra*cos(PI*5.0/12.0)" z="0.0" block="FESC"  >
            </Placement>
            
            <Placement y="INSE_Rb*sin(PI/4.0)" x="(xoffFEDC)/2.0-INSE_Rb*cos(PI/4.0)" z="0.0" block="FESC"  >
            </Placement>
            
            <Placement y="-INSE_Rb*sin(PI/4.0)" x="(xoffFEDC)/2.0-INSE_Rb*cos(PI/4.0)" z="0.0" block="FESC"  >
            </Placement>
            
        </Block>
        

        <Block name="FETC" comment="is Air Enclosure part"  >
            <Material name="Air"  />
            <Attribute for="FETC" seen="1" colo="6"  />
            <Shape type="tubs" rmin="0.0" rmax="INSE_RMax" dz="INSE_GateDepth/2.0" phi2="-90" phi1="90"  />
        </Block>
        
        <Block name="FERC" comment="is Air Enclosure part"  >
            <Material name="Air"  />
            <Attribute for="FERC" seen="1" colo="6"  />
            <Shape type="tubs" rmin="0.0" rmax="INSE_RMax" dz="INSE_GateDepth/2.0" phi2="90" phi1="-90"  />
        </Block>
        

        <Block name="FESC" comment="is Air Enclosure part"  >
            <Material name="Air"  />
            <Attribute for="FESC" seen="1" colo="6"  />
            <Shape type="tube" rmax="INSE_Diam/2.0" rmin="0.0" dz="INSE_GateDepth/2.0"  />
        </Block>
        
        <Block name="FPCT" comment="is Photo Cathode"  >
            <Material name="Air"  />
            <Medium name="PhotCath" isvol="1 "  />
            <Attribute for="LPCT" seen="1" colo="6"  />
            <Shape type="tube" dz="FLGG_PhCathDz/2.0" rmin="0" rmax="FLGG_PhCathR"  />
            <If expr="FMCG_ChkvSim==1"  >
                <Call expr="%Imed,N,E,ABSCO_PhCath,EFFIC_PhCath,RINDEX_PhCath" routine="GSCKOV"  />
                <Instrument block="FPCT">
                     <Hit meas="user" nbits="0" min="0" max="100000" />
                </Instrument>
            </If>
            
        </Block>
        
        <Block name="FUMT" comment="is mu metal"  >
            <Material name="iron"  />
            <Attribute for="LUMT" seen="1" colo="5"  />
            <Shape type="tube" dz="FLGG_MuMetDz/2.0" rmin="FLGG_PhCathR" rmax="FLGG_MuMetR"  />
            <If expr="fmcg_ChkvSim==1"  >
                <Call expr="%Imed,N,E,ABSCO_MuMet,EFFIC_All,RINDEX_MuMet" routine="GSCKOV"  />
            </If>
            
        </Block>
        
        <Block name="PBPT" comment="is pb plate"  >
            <Material name="Lead"  />
            <Attribute for="PBPT" seen="1" colo="7"  />
            <Shape type="BOX" dz="PBPD_Thick/2.0" dx="PBPD_Width/2.0" dy="PBPD_Height/2.0"  />
        </Block>
        
        <Block name="FSHM" comment="is the SHower Max section"  >
            <Material name="Air"  />
            <Attribute for="FSHM" seen="1" colo="4"  />
            <Shape type="BOX" dz="ztotsmd" dx="FMXG_G10Width/2.0" dy="FMXG_G10hgt/2.0"  />
            wsmd=FMXG_Sbase/2.0+FMXG_Sgap 
            wtotsmd=(FMXG_Nstrip+1)*wsmd 
            zsmd=-ztotsmd+FMXG_G10Thick/2.0 
            <Create block="FXGT"  />
            <Placement y="0" x="0" z="zsmd" block="FXGT"  >
            </Placement>
            

            xsmdv=-wtotsmd/2.0-FMXG_Sgap/2.0+wsmd 
            ysmdv=0.0 
            zsmdv=zsmd+FMXG_G10Thick/2.0+FMXG_Sapex/2.0 
            <Do var="i" from="1" to="FMXG_Nstrip"  >
                <If expr="mod(i,2)!=0"  >
                    <Create block="FHMS"  />
                    <Placement y="ysmdv" x="xsmdv" z="zsmdv" block="FHMS"  >
                    </Placement>
                    
                    <Else  >
                        <Create block="FHMS"  />
                        <Placement y="ysmdv" x="xsmdv" z="zsmdv" block="FHMS"  >
                            <Rotation alphax="180"  />
                        </Placement>
                        
                    </Else>
                    
                </If>
                
                xsmdv=xsmdv+wsmd 
            </Do>
            

            zsmd2=zsmdv+FMXG_G10Thick/2.0+FMXG_Sapex/2.0 
            <Create block="FXGT"  />
            <Placement y="0" x="0" z="zsmd2" block="FXGT"  >
            </Placement>
            
            xsmdh=0.0 
            ysmdh=-wtotsmd/2.0-FMXG_Sgap/2.0+wsmd 
            zsmdh=zsmd2+FMXG_G10Thick/2.0+FMXG_Sapex/2.0 
            <Create block="FHMS"  />
            <Do var="i" from="1" to="FMXG_Nstrip"  >
                <If expr="mod(i,2)!=0"  >
                    <Placement y="ysmdh" x="xsmdh" z="zsmdh" block="FHMS"  >
                        <Rotation ort="Y-XZ"  />
                    </Placement>
                    
                    <Else  >
                        <Placement y="ysmdh" x="xsmdh" z="zsmdh" block="FHMS"  >
                            <Rotation ort="YX-Z"  />
                        </Placement>
                        
                    </Else>
                    
                </If>
                
                ysmdh=ysmdh+wsmd 
            </Do>
            

        </Block>
        
        <Block name="FXGT" comment="is the G10 layer in the SMax"  >
            <Mixture name="g10" dens="1.7"  >
                <Component name="Si" a="28.08" z="14" w="0.6*1*28./60."  />
                <Component name="O" a="16" z="8" w="0.6*2*16./60."  />
                <Component name="C" a="12" z="6" w="0.4*8*12./174."  />
                <Component name="H" a="1" z="1" w="0.4*14*1./174."  />
                <Component name="O" a="16" z="8" w="0.4*4*16./174."  />
            </Mixture>
            
            <Attribute for="FXGT" seen="1" colo="7"  />
            <Shape type="BOX" dz="FMXG_G10Thick/2" dx="FMXG_G10Width/2" dy="FMXG_G10hgt/2"  />
            <Cut name="CUTGAM" value="0.00001"  />
            <Cut name="CUTELE" value="0.00001"  />
        </Block>
        
        <Block name="FHMS" comment="is sHower Max Strip"  >
            <Material name="POLYSTYREN"  />
            <Material name="Cpolystyren" isvol="1"  />
            <Attribute for="FHMS" seen="1" colo="2"  />
            <Shape type="TRD1" dz="fmxg_Sapex/2.0" dx2="fmxg_Sbase/2.0" dx1="0" dy="FMXG_G10hgt/2.0"  />
            <Cut name="CUTGAM" value="0.00008"  />
            <Cut name="CUTELE" value="0.001"  />
            <Cut name="BCUTE" value="0.0001"  />
            <Par name="BIRK1" value="1."  />
            <Par name="BIRK2" value="0.0130"  />
            <Par name="BIRK3" value="9.6E-6"  />
            <Instrument block="FHMS">
            <Hit meas="birk" nbits="0" min="0" max="10"/>
            </Instrument>
        </Block>
        

    </Module>
    

</Document>

