<Document file="StarVMC/Geometry/EcalGeo/EcalGeo.xml">

    <Module name="ECALGEO" comment=" is the EM EndCap Calorimeter GEOmetry "  >
        <Created date="   26 jan 1996 "  />
        <Author name="Rashid Mehdiyev"  />

        <CDE  >
            AGECOM
            GCONST
            GCUNIT
        </CDE>
        
        <Content  >
            EAGA,EALP,ECAL,ECHC,ECVO,ECGH,EFLP,EHMS,ELED,EMGT,EMOD,EPER,EPSB,ERAD,ERCM,ERSM,ESHM,ESEC,ESCI,ESPL,ESSP,EMSS,ETAR,EXGT,EXSG
        </Content>
        
        <Structure name="EMCG"  >
            <var name="Version" type="float"  />
            <var name="onoff" type="int"  />
            <var name="fillmode" type="int"  />
        </Structure>
        

        <Structure name="EMCS"  >
            <var name="Type" type="float"  />
            <var name="ZOrig" type="float"  />
            <var name="ZEnd" type="float"  />
            <var name="EtaMin" type="float"  />
            <var name="EtaMax" type="float"  />
            <var name="PhiMin" type="float"  />
            <var name="PhiMax" type="float"  />
            <var name="Offset" type="float"  />
            <var name="Nsupsec" type="float"  />
            <var name="Nsector" type="float"  />
            <var name="Nsection" type="float"  />
            <var name="Nslices" type="float"  />
            <var name="Front" type="float"  />
            <var name="AlinCell" type="float"  />
            <var name="Frplast" type="float"  />
            <var name="Bkplast" type="float"  />
            <var name="PbPlate" type="float"  />
            <var name="LamPlate" type="float"  />
            <var name="BckPlate" type="float"  />
            <var name="Hub" type="float"  />
            <var name="Rmshift" type="float"  />
            <var name="SMShift" type="float"  />
            <var name="GapPlt" type="float"  />
            <var name="GapCel" type="float"  />
            <var name="GapSMD" type="float"  />
            <var name="SMDcentr" type="float"  />
            <var name="TieRod(2)" type="float"  />
            <var name="Bckfrnt" type="float"  />
            <var name="GapHalf" type="float"  />
            <var name="Cover" type="float"  />
        </Structure>
        
        <Structure name="EETR"  >
            <var name="Type" type="float"  />
            <var name="Etagr" type="float"  />
            <var name="Phigr" type="float"  />
            <var name="Neta" type="float"  />
            <var name="EtaBin(13)" type="float"  />
        </Structure>
        
        <Structure name="ESEC"  >
            <var name="Isect" type="float"  />
            <var name="FPlmat" type="float"  />
            <var name="Cell" type="float"  />
            <var name="Scint" type="float"  />
            <var name="Nlayer" type="float"  />
        </Structure>
        
        <Structure name="EMXG"  >
            <var name="Version" type="float"  />
            <var name="Sapex" type="float"  />
            <var name="Sbase" type="float"  />
            <var name="Rin" type="float"  />
            <var name="Rout" type="float"  />
            <var name="F4" type="float"  />
        </Structure>
        
        <Structure name="EXSE"  >
            <var name="Jsect" type="float"  />
            <var name="Zshift" type="float"  />
            <var name="Sectype(6)" type="float"  />
        </Structure>
        
        <varlist type="INTEGER"  >
            I_section,J_section,Ie,is,isec,i_str,Nstr,Type,ii,jj,cut,fsect,lsect,ihalf,filled,myKase
        </varlist>
        
        <varlist type="REAL"  >
            center,Plate,Cell,G10,diff,halfi,tan_low,tan_upp,RBot,Rtop,Deta,etax,sq2,sq3,dup,dd,d2,d3,rshift,dphi,radiator,orgkeep,endkeep
        </varlist>
        
        <varlist type="REAL"  >
            maxcnt,msecwd,mxgten,curr,Secwid,Section,curcl,EtaTop,EtaBot,slcwid,zslice,Gap,mgt,xleft,xright,yleft,yright,current,rth,len,p,xc,yc,xx,yy,rbotrad,Rdel,dxy,ddn,ddup
        </varlist>
        
        <varlist type="INTEGER"  >
            N
        </varlist>
        
        <Parameter name="N" value="12"  />
        <!-- Tanf(etax) = tan(2*atan(exp(-etax))) -->
        <Inline name="tanf" type="real"> 
        	<Arguement type="real" name="etax" />
        	<Return value="tan(2*atan(exp(-etax)))" />
        </Inline>   

        <Fill name="EMCG" comment="EM EndCAp Calorimeter basic data"  >
            <var name="Version" value="5.0" comment=" Geometry version  "  />
            <var name="OnOff" value="3" comment=" Configurations 0-no, 1-west 2-east 3-both "  />
            <var name="FillMode" value="3" comment=" sectors fill mode  "  />

        </Fill>
        
        <Fill name="EMCS" comment="EM Endcap Calorimeter geometry"  >
            <var name="Type" value="1" comment=" =1 endcap, =2 fpd edcap prototype "  />
            <var name="ZOrig" value="268.763" comment=" calorimeter origin in z "  />
            <var name="ZEnd" value="310.007" comment=" Calorimeter end in z "  />
            <var name="EtaMin" value="1.086" comment=" upper feducial eta cut  "  />
            <var name="EtaMax" value="2.000" comment=" lower fiducial eta cut  " />
            <var name="PhiMin" value="-90" comment=" Min phi  "  />
            <var name="PhiMax" value="90" comment=" Max phi "  />
            <var name="Offset" value="0.0" comment=" offset in x "  />
            <var name="Nsupsec" value="6" comment=" Number of azimuthal supersectors         "  />
            <var name="Nsector" value="30" comment=" Number of azimutal sectors (Phi granularity) "  />
            <var name="Nslices" value="5" comment=" number of phi slices in supersector "  />
            <var name="Nsection" value="4" comment=" Number of readout sections "  />
            <var name="Front" value="0.953" comment=" thickness of the front AL plates "  />
            <var name="AlinCell" value="0.02" comment=" Aluminim plate in cell "  />
            <var name="Frplast" value="0.015" comment=" Front plastic in megatile "  />
            <var name="Bkplast" value="0.155" comment=" Fiber routing guides and back plastic "  />
            <var name="Pbplate" value="0.457" comment=" Lead radiator thickness "  />
            <var name="LamPlate" value="0.05" comment=" Laminated SS plate thickness "  />
            <var name="BckPlate" value="3.175" comment=" Back SS plate thickness "  />
            <var name="Hub" value="3.81" comment=" thickness of EndCap hub "  />
            <var name="Rmshift" value="2.121" comment=" radial shift of module "  />
            <var name="smshift" value="0.12" comment=" radial shift of steel support walls "  />
            <var name="GapPlt" value="0.3/2" comment=" HALF of the inter-plate gap in phi "  />
            <var name="GapCel" value="0.03/2" comment=" HALF of the radial inter-cell gap "  />
            <var name="GapSMD" value="3.400" comment=" space for SMD detector "  />
            <var name="SMDcentr" value="279.542" comment=" SMD position "  />
            <var name="TieRod" value="{160.,195}" comment=" Radial position of tie rods "  />
            <var name="Bckfrnt" value="306.832" comment=" Backplate front Z "  />
            <var name="GapHalf" value="0.4" comment=" 1/2 Gap between halves of endcap wheel "  />
            <var name="Cover" value="0.075" comment=" Cover of wheel half "  />
        </Fill>
        
        <Fill name="EETR" comment="Eta and Phi grid values"  >
            <var name="Type" value="1" comment=" =1 endcap, =2 fpd "  />
            <var name="EtaGr" value="1.0536" comment=" eta_top/eta_bot tower granularity "  />
            <var name="PhiGr" value="0.0981747" comment=" Phi granularity (radians) "  />
            <var name="NEta" value="12" comment=" Eta granularity "  />
            <var name="EtaBin" value="{2.0,1.9008,1.8065,1.7168,1.6317,1.5507,1.4738,1.4007,1.3312,1.2651,1.2023,1.1427,1.086}" comment=" Eta rapidities "  />
        </Fill>
        
        <Fill name="ESEC" comment="First EM section"  >
            <var name="ISect" value="1" comment=" Section number    "  />
            <var name="Nlayer" value="1" comment=" Number of Sci layers along z "  />
            <var name="Cell" value="1.505" comment=" Cell full width in z "  />
            <var name="Scint" value="0.5" comment=" Sci layer thickness "  />
        </Fill>
        
        <Fill name="ESEC" comment="First EM section"  >
            <var name="ISect" value="2" comment=" Section number    "  />
            <var name="Nlayer" value="1" comment=" Number of Sci layers along z "  />
            <var name="Cell" value="1.505" comment=" Cell full width in z "  />
            <var name="Scint" value="0.5" comment=" Sci layer thickness "  />
        </Fill>
        
        <Fill name="ESEC" comment="Second EM section"  >
            <var name="ISect" value="3" comment=" Section number "  />
            <var name="Nlayer" value="4" comment=" Number of Sci layers along z "  />
            <var name="Cell" value="1.405" comment=" Cell full width in z "  />
            <var name="Scint" value="0.4" comment=" Sci layer thickness "  />
        </Fill>
        
        <Fill name="ESEC" comment="Third EM section"  >
            <var name="ISect" value="4" comment=" Section "  />
            <var name="Nlayer" value="18" comment=" Number of layers along z "  />
            <var name="Cell" value="1.405" comment=" Cell full width in z "  />
            <var name="Scint" value="0.4" comment=" Sci layer thickness "  />
        </Fill>
        
        <Fill name="ESEC" comment="4th EM section"  >
            <var name="ISect" value="5" comment=" Section "  />
            <var name="Nlayer" value="1" comment=" Number of  layers along z "  />
            <var name="Cell" value="1.505" comment=" Cell full width in z "  />
            <var name="Scint" value="0.5" comment=" Sci layer thickness "  />
        </Fill>
        
        <Fill name="EMXG" comment="EM Endcap SMD basic data"  >
            <var name="Version" value="1" comment=" Geometry version "  />
            <var name="Sapex" value="0.7" comment=" Scintillator strip apex "  />
            <var name="Sbase" value="1.0" comment=" Scintillator strip base "  />
            <var name="Rin" value="77.41" comment=" inner radius of SMD plane   "  />
            <var name="Rout" value="213.922" comment=" outer radius of SMD plane "  />
            <var name="F4" value=".15" comment=" F4 thickness "  />
        </Fill>
        
        <Fill name="EXSE" comment="First SMD section"  >
            <var name="JSect" value="1" comment=" Section number "  />
            <var name="Zshift" value="-1.215" comment=" Section width "  />
            <var name="sectype" value="{4,1,0,2,1,0}" comment=" 1-V,2-U,3-cutV,4-cutU     "  />
        </Fill>
        
        <Fill name="EXSE" comment="Second SMD section"  >
            <var name="JSect" value="2" comment=" Section number    "  />
            <var name="Zshift" value="0." comment=" Section width "  />
            <var name="sectype" value="{0,2,1,0,2,3}" comment=" 1-V,2-U,3-cutV,4-cutU     "  />
        </Fill>
        
        <Fill name="EXSE" comment="Third SMD section"  >
            <var name="JSect" value="3" comment=" Section number    "  />
            <var name="Zshift" value="1.215" comment=" Section width "  />
            <var name="sectype" value="{1,0,2,1,0,2}" comment=" 1-V,2-U,3-cutV,4-cutU     "  />
        </Fill>
        

        <Use struct="EMCG"  />
        sq3 = sqrt(3.) 
        sq2 = sqrt(2.) 

        <Print level="1" fmt="'ECALGEO version ', F4.2"  >
            emcg_version  
        </Print>
        

        <Use struct="EMCS" select="type" value="1 "  />
        <Use struct="EETR" select="type" value="1 "  />
        orgkeep =  emcs_ZOrig 
        endkeep =  emcs_ZEnd 
        <If expr="emcg_OnOff&gt;0"  >
            diff = 0.0 
            center  = (emcs_ZOrig+emcs_ZEnd)/2 
            Tan_Upp = tanf(emcs_EtaMin) 
            Tan_Low = tanf(emcs_EtaMax) 
            rth  = sqrt(1. + Tan_Low*Tan_Low) 
            rshift  = emcs_Hub * rth 
            dup=emcs_Rmshift*Tan_Upp 
            dd=emcs_Rmshift*rth 
            d2=rshift + dd 
            radiator  = emcs_Pbplate + 2*emcs_LamPlate 
            dphi = (emcs_PhiMax-emcs_PhiMin)/emcs_Nsector 
            <Create block="ECAL"  />
            <If expr="emcg_OnOff==1|emcg_OnOff==3"  >
                <Placement z="+center" block="ECAL" in="CAVE"  >
                </Placement>
                
            </If>
            
            <If expr="emcg_OnOff==2|emcg_OnOff==3"  >
                <Placement z="-center" block="ECAL" in="CAVE"  >
                    <Rotation thetaz="180"  />
                </Placement>
                
            </If>
            

            <If expr="section&gt;emcs_Zend"  >
                <Print level="0" fmt="' ECALGEO error: sum of sections exceeds maximum ',2F12.4"  >
                    section,emcs_Zend 
                </Print>
                
            </If>
            
            <Print level="1" fmt="' EndCap calorimeter total depth ',F12.4"  >
                section 
            </Print>
            
        </If>
        
        <Print level="1" fmt="'ECALGEO finished'"  >
        </Print>
        
        <Block name="ECAL" comment="is one EMC EndCap wheel"  >
            <Material name="Air"  />
            <Medium name="standard"  />
            <Attribute for="ECAL" seen="1" colo="7"  />
            <Shape type="CONE" rmn1="orgkeep*Tan_Low-d2" rmn2="endkeep*Tan_Low-d2" rmx2="endkeep*Tan_Upp+dup" rmx1="orgkeep*Tan_Upp+dup" dz="(emcs_Zend-emcs_ZOrig)/2"  />


            <Do var="ihalf" from="1" to="2"  >
                filled=1 
                halfi = -105 + (ihalf-1)*180 
                <If expr="(ihalf==2&amp;emcg_FillMode&lt;3)"  >
                    filled = 0       
                </If>
                

                <Create block="EAGA"  />
                <Placement block="EAGA"  >
                    <Rotation alphaz="halfi"  />
                </Placement>
                

            </Do>
            
        </Block>
        
        <Block name="EAGA" comment="is half of wheel air volume for the EndCap module"  >
            <Attribute for="EAGA" seen="1" serial="filled" colo="1"  />
            <Material name="Air"  />
            <Shape type="CONS" rmn1="orgkeep*Tan_Low-d2" rmn2="endkeep*Tan_Low-d2" rmx2="endkeep*Tan_Upp+dup" rmx1="orgkeep*Tan_Upp+dup" dz="(emcs_Zend-emcs_ZOrig)/2" phi2="emcs_PhiMax" phi1="emcs_PhiMin"  />

            <If expr="filled==1"  >
                <Create block="EMSS"  />
                <Placement konly="'MANY'" block="EMSS"  >
                </Placement>
                
                curr = orgkeep ; curcl = endkeep 
                <Create block="ECGH"  />
                <Placement konly="'ONLY'" block="ECGH"  >
                    <Rotation alphaz="90"  />
                </Placement>
                
            </If>
            


        </Block>
        

        <Block name="EMSS" comment="is steel support of the EndCap module"  >
            <Attribute for="EMSS" seen="1" colo="1"  />
            <Material name="Iron"  />
            <Shape type="CONS" rmn1="orgkeep*Tan_Low-d2" rmn2="endkeep*Tan_Low-d2" rmx2="endkeep*Tan_Upp+dup" rmx1="orgkeep*Tan_Upp+dup" dz="(emcs_Zend-emcs_ZOrig)/2" phi2="emcs_PhiMax" phi1="emcs_PhiMin"  />

            zslice = emcs_ZOrig 
            <Print level="1" fmt="' Front Al plane starts at: ',F12.4"  >
                zslice 
            </Print>
            
            slcwid  = emcs_Front 
            <Create block="EFLP"  />
            <Placement z="zslice-center+slcwid/2" block="EFLP"  >
            </Placement>
            
            zslice = zslice + slcwid 
            <Print level="1" fmt="' First calorimeter starts at: ',F12.4"  >
                zslice 
            </Print>
            

            fsect = 1; lsect = 3 

            slcwid = emcs_SMDcentr - emcs_GapSMD/2 - zslice 
            <Create block="ECVO"  />
            <Placement z="zslice-center+slcwid/2" block="ECVO"  >
            </Placement>
            

            slcwid  = emcs_GapSMD 
            zslice = emcs_SMDcentr - emcs_GapSMD/2 

            <Print level="1" fmt="' 1st calorimeter ends, SMD starts at: ',2F10.5"  >
                section,zslice 
            </Print>
            

            <Create block="ESHM"  />
            <Placement z="zslice-center+slcwid/2" block="ESHM"  >
            </Placement>
            
            zslice = zslice + slcwid 

            <Print level="1" fmt="' SMD ends at: ',F10.5"  >
                zslice 
            </Print>
            
            slcwid = 0 
            fsect = 4; lsect = 5 
            <Do var="I_section" from="fsect" to="lsect"  >
                <Use struct="ESEC" select="Isect" value="I_section   "  />
                Slcwid  = slcwid + esec_cell*esec_Nlayer 
            </Do>
            

            slcwid = emcs_bckfrnt - zslice 

            <Create block="ECVO"  />
            <Placement z="zslice-center+slcwid/2" block="ECVO"  >
            </Placement>
            

            zslice = emcs_bckfrnt 

            <Print level="1" fmt="' 2nd calorimeter ends, Back plate starts at: ',2F10.5"  >
                section,zslice 
            </Print>
            

            slcwid  = emcs_BckPlate 
            <Create block="ESSP"  />
            <Placement z="zslice-center+slcwid/2" block="ESSP"  >
            </Placement>
            
            zslice = zslice + slcwid 
            <Print level="1" fmt="' BackPlate ends at: ',F10.5"  >
                zslice 
            </Print>
            

            slcwid = emcs_Zend-emcs_ZOrig 
            <Create block="ERCM"  />

            <Do var="i_str" from="1" to="2"  >
                <Do var="is" from="1" to="5"  >
                    xx = emcs_phimin + is*30 
                    yy = xx*degrad 
                    xc = cos(yy)*emcs_TieRod(i_str) 
                    yc = sin(yy)*emcs_TieRod(i_str) 
                    <Placement y="yc" x="xc" z="0" block="ERCM"  >
                    </Placement>
                    
                </Do>
                
            </Do>
            

            rth = orgkeep*Tan_Upp+dup + 2.5/2 
            xc = (endkeep - orgkeep)*Tan_Upp 
            len = .5*(endkeep + orgkeep)*Tan_Upp + dup + 2.5/2 
            yc = emcs_Zend-emcs_ZOrig 
            p = atan(xc/yc)/degrad 

            <Create block="EPSB"  />
            <Do var="is" from="1" to="6"  >
                xx = -75 + (is-1)*30 
                yy = xx*degrad 
                xc = cos(yy)*len 
                yc = sin(yy)*len 
                <Placement y="yc" x="xc" block="EPSB"  >
                    <Rotation alphaz="xx"  />
                </Placement>
                
            </Do>
            

        </Block>
        
        <Block name="ECVO" comment="is one of EndCap Volume with megatiles and radiators"  >
            <Material name="Air"  />
            <Attribute for="ECVO" seen="1" colo="3"  />
            <Shape type="CONS" rmn1="zslice*Tan_Low-dd" rmn2="(zslice+slcwid)*Tan_Low-dd" rmx2="(zslice+slcwid)*Tan_Upp+dup" rmx1="zslice*Tan_Upp+dup" dz="slcwid/2"  />

            <Do var="J_section" from="1" to="6"  >

                <If expr="emcg_fillmode&gt;1"  >
                    filled=1 
                    <Elif expr="j_section&gt;1&amp;j_section&lt;6"  >
                        filled=1 
                    </Elif>
                    
                    <Else  >
                        filled=0 
                    </Else>
                    
                </If>
                
                d3 = 75 - (J_section-1)*30 
                <Create block="EMOD"  />
                <Placement ncopy="J_section" block="EMOD"  >
                    <Rotation alphaz="d3"  />
                </Placement>
                
            </Do>
            


        </Block>
        
        <Block name="ESHM" comment="is the SHower Max section"  >
            <Material name="Air"  />
            <Attribute for="ESHM" seen="1" colo="4"  />
            <Shape type="CONS" rmn1="zslice*Tan_Low-dd" rmn2="(zslice+slcwid)*Tan_Low-dd" rmx2="(zslice+slcwid)*Tan_Upp+dup" rmx1="(zslice)*Tan_Upp+dup" dz="SlcWid/2" phi2="emcs_PhiMax" phi1="emcs_PhiMin"  />

            <Use struct="EMXG" select="Version" value="1 "  />
            maxcnt = emcs_SMDcentr 
            <Print level="1" fmt="' Z start for SMD,section: ',3F12.4"  >
                zslice,section,center 
            </Print>
            
            <Do var="J_section" from="1" to="3"  >
                <Use struct="EXSE" select="Jsect" value="J_section "  />
                current = exse_Zshift 
                secwid  = emxg_Sapex + 2.*emxg_F4 
                section = maxcnt + exse_zshift 
                <Print level="1" fmt="' layer, Z, width : ',i3,3F12.4"  >
                    j_section,current,section,secwid 
                </Print>
                
                rbot=section*Tan_Low 
                rtop=section*Tan_Upp 
                <Print level="1" fmt="' layer, rbot,rtop : ',i3,2F12.4"  >
                    j_section,rbot,rtop 
                </Print>
                
                <Create block="ESPL"  />
                <Placement z="current" block="ESPL"  >
                </Placement>
                
            </Do>
            

            <Create block="ERSM"  />
            <Do var="i_str" from="1" to="2"  >
                <Do var="is" from="1" to="5"  >
                    xx = emcs_phimin + (is)*30 
                    yy = xx*degrad 
                    xc = cos(yy)*emcs_TieRod(i_str) 
                    yc = sin(yy)*emcs_TieRod(i_str) 
                    <Placement y="yc" x="xc" z="0" block="ERSM"  >
                    </Placement>
                    
                </Do>
                
            </Do>
            

        </Block>
        
        <Block name="ECGH" comment="is air Gap between endcap Half wheels"  >
            <Material name="Air"  />
            <Medium name="standard"  />
            <Attribute for="ECGH" seen="0" colo="7"  />
            <Shape type="TRD1" dz="(emcs_Zend-emcs_ZOrig)/2" dx2="endkeep*Tan_Upp+dup" dx1="orgkeep*Tan_Upp+dup" dy="(emcs_gaphalf+emcs_cover)/2"  />

            rth = emcs_GapHalf + emcs_cover 
            xx=curr*Tan_Low-d2 
            xleft = sqrt(xx*xx - rth*rth) 
            yy=curr*Tan_Upp+dup 
            xright = sqrt(yy*yy - rth*rth) 
            secwid = yy - xx 
            xx=curcl*Tan_Low-d2 
            yleft = sqrt(xx*xx - rth*rth) 
            yy=curcl*Tan_Upp+dup 
            yright = sqrt(yy*yy - rth*rth) 
            slcwid = yy - xx 
            xx=(xleft+xright)/2 
            yy=(yleft + yright)/2 
            xc = yy - xx 
            len = (xx+yy)/2 
            yc = curcl - curr 
            p = atan(xc/yc)/degrad 
            rth = -(emcs_GapHalf + emcs_cover)/2 
            <Create block="ECHC"  />
            <Placement y="rth" x="len" block="ECHC"  >
            </Placement>
            
            <Placement y="rth" x="-len" block="ECHC"  >
                <Rotation alphaz="180"  />
            </Placement>
            

        </Block>
        
        <Block name="ECHC" comment="is steel EndCap Half Cover"  >
            <Attribute for="ECHC" seen="1" colo="1"  />
            <Material name="Iron"  />
            <Shape type="TRAP" tl2="slcwid/2" alp1="0" alp2="0" h2="emcs_cover/2" h1="emcs_cover/2" bl1="secwid/2" tl1="secwid/2" bl2="slcwid/2" phi="0" dz="(curcl-curr)/2" thet="p"  />
        </Block>
        
        <Block name="ESSP" comment="is Stainless Steel back Plate"  >
            <Material name="Iron"  />
            <Attribute for="ESSP" seen="1" colo="6" fill="1"  />
            <Shape type="CONS" rmn1="zslice*Tan_Low-dd" rmn2="(zslice+slcwid)*Tan_Low-dd" rmx2="(zslice+slcwid)*Tan_Upp+dup" rmx1="zslice*Tan_Upp+dup" dz="emcs_BckPlate/2" phi2="emcs_PhiMax" phi1="emcs_PhiMin"  />
        </Block>
        
        <Block name="EPSB" comment="is Projectile Stainless steel Bar"  >
            <Material name="Iron"  />
            <Attribute for="EPSB" seen="1" colo="6" fill="1"  />
            <Shape type="TRAP" tl2="2.5/2" alp1="0" alp2="0" h2="2.0/2" h1="2.0/2" bl1="2.5/2" tl1="2.5/2" bl2="2.5/2" phi="0" dz="(emcs_Zend-emcs_ZOrig)/2" thet="p"  />
        </Block>
        
        <Block name="ERCM" comment="is stainless steel tie Rod in CaloriMeter sections"  >
            <Material name="Iron"  />
            <Attribute for="ERSM" seen="1" colo="6" fill="1"  />
            <Shape type="TUBE" dz="slcwid/2" rmin="0" rmax="1.0425"  />
        </Block>
        
        <Block name="ERSM" comment="is stainless steel tie Rod in Shower Max"  >
            <Material name="Iron"  />
            <Attribute for="ERSM" seen="1" colo="6" fill="1"  />
            <Shape type="TUBE" dz="slcwid/2" rmin="0" rmax="1.0425"  />
        </Block>
        
        <Block name="EMOD" comment="is one module of the EM EndCap"  >
            <Attribute for="EMOD" seen="1" serial="filled" colo="3"  />
            <Material name="Air"  />
            <Shape type="CONS" rmn1="zslice*Tan_Low-dd" rmn2="(zslice+slcwid)*Tan_Low-dd" rmx2="(zslice+slcwid)*Tan_Upp+dup" rmx1="zslice*Tan_Upp+dup" dz="slcwid/2" phi2="emcs_PhiMax/emcs_Nsupsec" phi1="emcs_PhiMin/emcs_Nsupsec"  />
            section = zslice 
            curr = zslice + slcwid/2 

            <Do var="I_section" from="fsect" to="lsect"  >

                <Use struct="ESEC" select="Isect" value="I_section   "  />
                Secwid  = esec_cell*esec_Nlayer 
                <If expr="I_section==3|I_section==5"  >
                    Secwid  = Secwid - radiator 
                    <Elif expr="I_section==4"  >
                        Secwid  = Secwid - esec_cell + radiator 
                    </Elif>
                    
                </If>
                
                <Create block="ESEC"  />
                <Placement z="section-curr+secwid/2" block="ESEC"  >
                </Placement>
                
                section = section + secwid 
            </Do>
            
        </Block>
        
        <Block name="ESEC" comment="is a single EM section"  >
            <Attribute for="ESEC" seen="1" serial="filled" colo="1"  />
            <Material name="Air"  />
            <Medium name="standard"  />
            <Shape type="CONS" rmn1="(section-diff)*Tan_Low-dd" rmn2="(section+secwid-diff)*Tan_Low-dd" rmx2="(section+secwid-diff)*Tan_Upp+dup" rmx1="(section-diff)*Tan_Upp+dup" dz="secwid/2"  />
            len = -secwid/2 
            current = section 
            mgt = esec_scint + emcs_AlinCell                               + emcs_FrPlast + emcs_BkPlast 
            gap = esec_cell - radiator - mgt 
            <Print level="2" fmt="' ESEC:I_section,section',i3,F12.4"  >
                I_section,section 
            </Print>
            

            <Do var="is" from="1" to="esec_Nlayer"  >
                Cell = esec_cell 
                plate = radiator 
                <If expr="is==nint(esec_Nlayer)&amp;(I_section==3|I_section==5)"  >
                    Cell = mgt + gap 
                    Plate=0 
                    <Elif expr="I_section==4&amp;is==1"  >
                        Cell = radiator   
                    </Elif>
                    
                </If>
                
                <Print level="2" fmt="' ESEC:I_section,is,len,cell,current ',2i3,3F12.4"  >
                    I_section,is,len,cell,current 
                </Print>
                

                <If expr="I_section==4&amp;is==1"  >
                    cell = radiator + .14 
                    <Create block="ERAD"  />
                    <Placement z="len+(cell)/2" block="ERAD"  >
                    </Placement>
                    
                    len = len + cell 
                    current = current + cell 
                    <Else  >
                        cell = mgt 
                        <If expr="filled==1"  >
                            <Create block="EMGT"  />
                            <Placement z="len+(gap+cell)/2" block="EMGT"  >
                            </Placement>
                            
                            xx = current + (gap+cell)/2 
                            <Print level="2" fmt="' MEGA I_section,is ',2i3,F10.4"  >
                                I_section,is,xx 
                            </Print>
                            
                        </If>
                        
                        len = len + cell + gap 
                        current = current + cell + gap 

                        <If expr="Plate&gt;0"  >
                            cell = radiator 
                            <Create block="ERAD"  />
                            <Placement z="len+cell/2" block="ERAD"  >
                            </Placement>
                            
                            len = len + cell 
                            current = current + cell 
                        </If>
                        
                    </Else>
                    
                </If>
                
            </Do>
            
        </Block>
        
        <Block name="EMGT" comment="is a megatile EM section"  >
            <Attribute for="EMGT" seen="1" colo="1"  />
            <Material name="Air"  />
            myKase=2 
            <If expr="(I_section==1|I_section==2|I_section==5)"  >
                myKase=1 
            </If>
            
            <If expr="myKase==1"  >
                <Material name="Air_EMGT1" isvol="0"  />
                <Else  >
                    <Material name="Air_EMGT2" isvol="0"  />
                </Else>
                
            </If>
            
            <Shape type="CONS" rmn1="(current-diff)*Tan_Low-dd" rmn2="(current+mgt-diff)*Tan_Low-dd" rmx2="(current+mgt-diff)*Tan_Upp+dup" rmx1="(current-diff)*Tan_Upp+dup" dz="mgt/2"  />

            <If expr="myKase==1"  >
                <Cut name="CUTGAM" value="0.00001"  />
                <Cut name="CUTELE" value="0.00001"  />
                <Else  >
                    <Cut name="CUTGAM" value="0.00008"  />
                    <Cut name="CUTELE" value="0.001"  />
                    <Cut name="BCUTE" value="0.0001"  />
                </Else>
                
            </If>
            
            <Do var="isec" from="1" to="nint(emcs_Nslices)"  >
                <Create block="EPER"  />
                <Placement block="EPER"  >
                    <Rotation alphaz="(emcs_Nslices/2-isec+0.5)*dphi"  />
                </Placement>
                
            </Do>
            
        </Block>
        
        <Block name="EPER" comment="is a EM subsection period (super layer)"  >
            <Material name="POLYSTYREN"  />
            <Attribute for="EPER" seen="1" colo="1"  />
            <Shape type="CONS" rmn1="(current-diff)*Tan_Low-dd" rmn2="(current+mgt-diff)*Tan_Low-dd" rmx2="(current+mgt-diff)*Tan_Upp+dup" rmx1="(current-diff)*Tan_Upp+dup" dz="mgt/2" phi2="+emcs_PhiMax/emcs_Nsector" phi1="emcs_PhiMin/emcs_Nsector"  />
            curcl = current+mgt/2  
            <Do var="ie" from="1" to="nint(eetr_NEta)"  >
                EtaBot  = eetr_EtaBin(ie) 
                EtaTop  = eetr_EtaBin(ie+1) 

                RBot=(curcl-diff)*Tanf(EtaBot) 
                <If expr="Plate&gt;0"  >
                    RTop=min((curcl-diff)*Tanf(EtaTop),                     ((current-diff)*Tan_Upp+dup)) 
                    <Else  >
                        RTop=min((curcl-diff)*Tanf(EtaTop),                     ((current-diff)*Tan_Upp+dup)) 
                    </Else>
                    
                </If>
                
                <Check expr=" RBot&lt;RTop "  />
                xx=tan(pi*emcs_PhiMax/180.0/emcs_Nsector) 
                yy=cos(pi*emcs_PhiMax/180.0/emcs_Nsector) 

                <Create block="ETAR"  />
                <Placement x="(RBot+RTop)/2" block="ETAR"  >
                    <Rotation ort="YZX"  />
                </Placement>
                
                <Print level="2" fmt="' EPER : ie,EtaTop,EtaBot,rbot,rtop ',i3,4F12.4"  >
                    ie,EtaTop,EtaBot,rbot,rtop 
                </Print>
                
            </Do>
            
        </Block>
        
        <Block name="ETAR" comment="is one CELL of scintillator, fiber and plastic"  >
            <Attribute for="ETAR" seen="1" colo="4"  />
            <Shape type="TRD1" dz="(RTop-RBot)/2" dx2="RTop*xx-emcs_GapCel/yy" dx1="RBot*xx-emcs_GapCel/yy" dy="mgt/2"  />
            <Create block="EALP"  />
            <Placement y="(-mgt+emcs_AlinCell)/2" block="EALP"  >
            </Placement>
            
            G10 = esec_scint 
            <Create block="ESCI"  />
            <Placement y="(-mgt+G10)/2+emcs_AlinCell+emcs_FrPlast" block="ESCI"  >
            </Placement>
            
        </Block>
        
        <Block name="ESCI" comment="is the active scintillator (polystyren) layer"  >
            <Material name="POLYSTYREN"  />
            <Material name="Cpolystyren" isvol="1"  />
            <Attribute for="ESCI" seen="1" colo="7" fill="0"  />
            <Shape type="TRD1" dz="(RTop-RBot)/2-emcs_GapCel" dy="esec_scint/2"  />
            <Cut name="CUTGAM" value="0.00008"  />
            <Cut name="CUTELE" value="0.001"  />
            <Cut name="BCUTE" value="0.0001"  />
            <Cut name="CUTNEU" value="0.001"  />
            <Cut name="CUTHAD" value="0.001"  />
            <Cut name="CUTMUO" value="0.001"  />
            <Par name="BIRK1" value="1."  />
            <Par name="BIRK2" value="0.013"  />
            <Par name="BIRK3" value="9.6E-6"  />
            <Instrument block="ESCI">
                 <Hit meas="birk" nbits="0" min="0" max="10" />
            </Instrument>
        </Block>
        
        <Block name="ERAD" comment="is radiator"  >
            <Material name="Iron"  />
            <Attribute for="ERAD" seen="1" colo="6" fill="1"  />
            <Shape type="CONS" rmn1="(current)*Tan_Low-dd" rmn2="(current+cell)*Tan_Low-dd" rmx2="(current+radiator)*Tan_Upp+dup" rmx1="(current)*Tan_Upp+dup" dz="radiator/2"  />

            <Create block="ELED"  />
            <Placement block="ELED"  >
            </Placement>
            

        </Block>
        
        <Block name="ELED" comment="is lead absorber Plate"  >
            <Material name="Lead"  />
            <Material name="Lead_ELED" isvol="0"  />
            <Attribute for="ELED" seen="1" colo="4" fill="1"  />
            <Shape type="TUBS" dz="emcs_Pbplate/2" rmin="(current)*Tan_Low" rmax="(current+emcs_Pbplate)*Tan_Upp"  />

            <Cut name="CUTGAM" value="0.00008"  />
            <Cut name="CUTELE" value="0.001"  />
            <Cut name="BCUTE" value="0.0001"  />
            <Cut name="CUTNEU" value="0.001"  />
            <Cut name="CUTHAD" value="0.001"  />
            <Cut name="CUTMUO" value="0.001"  />

        </Block>
        
        <Block name="EFLP" comment="is First Aluminium plate"  >
            <Material name="Aluminium"  />
            <Attribute for="EFLP" seen="1" colo="3" fill="1"  />
            <Shape type="CONS" rmn1="68.813" rmn2="68.813" rmx2="(zslice+slcwid-diff)*Tan_Upp+dup" rmx1="(zslice-diff)*Tan_Upp+dup" dz="emcs_Front/2" phi2="emcs_PhiMax" phi1="emcs_PhiMin"  />


        </Block>
        
        <Block name="EALP" comment="is ALuminium Plate in calorimeter cell"  >
            <Material name="Aluminium"  />
            <Material name="StrAluminium" isvol="0"  />
            <Attribute for="EALP" seen="1" colo="1"  />
            <Shape type="TRD1" dz="(RTop-RBot)/2" dy="emcs_AlinCell/2"  />
            <Cut name="CUTGAM" value="0.00001"  />
            <Cut name="CUTELE" value="0.00001"  />
            <Par name="LOSS" value="1."  />
            <Par name="STRA" value="1."  />
        </Block>
        
        <Block name="ESPL" comment="is one of the Shower max PLanes"  >
            <Material name="Air"  />
            <Attribute for="ESPL" seen="1" colo="3"  />
            <Shape type="TUBS" rmin="section*Tan_Low-1.526" rmax="(section-secwid/2)*Tan_Upp+dup" dz="SecWid/2" phi2="emcs_PhiMax" phi1="emcs_PhiMin"  />

            <Use struct="EMXG" select="Version" value="1 "  />
            msecwd = (emxg_Sapex+emxg_F4)/2 
            <Do var="isec" from="1" to="6"  >
                cut=1 
                d3 = 75 - (isec-1)*30 
                <If expr="exse_sectype(isec)==0|(emcg_FillMode==1&amp;(isec==6|isec==1))"  >
                    cut = 0 
                    <Create block="EXSG"  />
                    <Placement ncopy="isec" block="EXSG"  >
                        <Rotation alphaz="d3"  />
                    </Placement>
                    
                    <Elif expr="exse_sectype(isec)==1"  >
                        <Create block="EXSG"  />
                        <Placement ncopy="isec" block="EXSG"  >
                            <Rotation alphaz="d3"  />
                        </Placement>
                        
                        <Create block="EXGT"  />
                        <Placement z="msecwd" block="EXGT"  >
                            <Rotation alphaz="d3"  />
                        </Placement>
                        
                        <Elif expr="exse_sectype(isec)==2"  >
                            <Create block="EXSG"  />
                            <Placement ncopy="isec" block="EXSG"  >
                                <Rotation alphaz="d3"  />
                                <Rotation ort="X-Y-Z"  />
                            </Placement>
                            
                            <Create block="EXGT"  />
                            <Placement z="-msecwd" block="EXGT"  >
                                <Rotation alphaz="d3"  />
                            </Placement>
                            
                            <Elif expr="exse_sectype(isec)==3"  >
                                cut=2 
                                <Create block="EXSG"  />
                                <Placement ncopy="isec" block="EXSG"  >
                                    <Rotation alphaz="d3"  />
                                </Placement>
                                
                                <Create block="EXGT"  />
                                <Placement z="msecwd" block="EXGT"  >
                                    <Rotation alphaz="d3"  />
                                </Placement>
                                
                                <Elif expr="exse_sectype(isec)==4"  >
                                    cut=2 
                                    <Create block="EXSG"  />
                                    <Placement ncopy="isec" block="EXSG"  >
                                        <Rotation alphaz="d3"  />
                                        <Rotation ort="X-Y-Z"  />
                                    </Placement>
                                    
                                    <Create block="EXGT"  />
                                    <Placement z="-msecwd" block="EXGT"  >
                                        <Rotation alphaz="d3"  />
                                    </Placement>
                                    
                                </Elif>
                                
                            </Elif>
                            
                        </Elif>
                        
                    </Elif>
                    
                </If>
                
            </Do>
            

        </Block>
        
        <Block name="EXSG" comment="is the Shower max Gap for scintillator strips"  >
            <Attribute for="EXSG" seen="1" serial="cut" colo="7"  />
            <Material name="Air"  />
            <Shape type="TUBS" rmin="section*Tan_Low-1.526" rmax="(section-secwid/2)*Tan_Upp+dup" dz="SecWid/2" phi2="emcs_PhiMax/emcs_Nsupsec" phi1="emcs_PhiMin/emcs_Nsupsec"  />
            Rbot = emxg_Rin 
            Rtop = emxg_Rout 

            <If expr="cut&gt;0"  >
                <If expr="cut==1"  >
                    Rdel = 3.938 
                    Nstr = 288 
                    <Else  >
                        Rdel = -.475 
                        Nstr = 285 
                    </Else>
                    
                </If>
                
                rth = .53*rdel        ! .53 --- tentatavily 
                ddn = sq3*1.713 + Rdel   
                ddup = .5*1.846 + 1.713  
                <Print level="2" fmt="' EXSG: Rbot,Rtop,Nstr',2F12.4,I5"  >
                    Rbot,Rtop,Nstr 
                </Print>
                
                mgt = emxg_Sbase + .01 
                <Do var="i_str" from="1" to="nstr"  >
                    p = .5*(i_str-1)*mgt + 41.3655 
                    <If expr="p&lt;=(.5*rbot*sq3+rth)"  >
                        dxy = 1.9375*sq2 
                        xleft = .5*sq2*p*(sq3 + 1.) - dxy 
                        yleft = .5*sq2*p*(sq3 - 1.) - dxy  
                        yright = .5*sq2*(sqrt( rbot*rbot - p*p) - p) 
                        xright = sq2*p + yright 
                        <Elif expr="(.5*rbot*sq3+rth)&lt;p&amp;p&lt;=(.5*Rtop+1.5)"  >
                            <Print level="2" fmt="' EXSG: 2 - -i_str,p:',i3,F12.4"  >
                                i_str,p 
                            </Print>
                            
                            dxy = 1.9375*sq2 
                            xleft = .5*sq2*p*(sq3 + 1.) - dxy 
                            yleft = .5*sq2*p*(sq3 - 1.) - dxy  
                            dxy = rdel*sq2/sq3 
                            yright = .5*sq2*p*(1.- 1./sq3) 
                            xright = sq2*p - yright - dxy 
                            yright = -yright - dxy 
                            <Elif expr="p&gt;(.5*rtop+1.5)"  >
                                <Print level="2" fmt="' EXSG: 3 - - i_str,p:',i3,F12.4"  >
                                    i_str,p 
                                </Print>
                                
                                yleft = (sqrt(rtop*rtop - p*p) - p)/sq2 
                                xleft = sq2*p + yleft 
                                dxy = rdel*sq2/sq3 
                                yright = .5*sq2*p*(1.- 1./sq3) 
                                xright = sq2*p - yright - dxy 
                                yright = -yright - dxy 
                                dxy = 0.  
                                <If expr="(.5*sq3*160.-ddn)&lt;p&amp;p&lt;=(.5*sq3*160.+ddup)"  >
                                    <Print level="2" fmt="' EXSG: 4 - - i_str,p:',i3,F12.4"  >
                                        i_str,p 
                                    </Print>
                                    
                                    xc = .5*(sq3*160.+1.846) 
                                    yc = xc - .5*sq3*1.713 
                                    <If expr="p&gt;yc"  >
                                        dxy = .5*sq2*(2/sq3*rdel + .5*sq3*1.846 +                                                                  sqrt(1.713*1.713 - (p-xc)*(p-xc))) 
                                        <Else  >
                                            dxy = sq2/sq3*(p - .5*sq3* 160. + ddn) 
                                        </Else>
                                        
                                    </If>
                                    
                                    <Elif expr="(.5*sq3*195.-ddn)&lt;p&amp;p&lt;=(.5*sq3*195.+ddup)"  >
                                        <Print level="2" fmt="' EXSG: 5 - - i_str,p:',i3,F12.4"  >
                                            i_str,p 
                                        </Print>
                                        
                                        xc = .5*(sq3*195.+1.846) 
                                        yc = xc - .5*sq3*1.713 
                                        <If expr="p&gt;yc"  >
                                            dxy = .5*sq2*(2/sq3*rdel + .5*sq3*1.846 +                                                                  sqrt(1.713*1.713 - (p-xc)*(p-xc))) 
                                            <Else  >
                                                dxy = sq2/sq3*(p - .5*sq3*195. + ddn) 
                                            </Else>
                                            
                                        </If>
                                        
                                    </Elif>
                                    
                                </If>
                                
                                xright = xright + dxy 
                                yright = yright + dxy 
                            </Elif>
                            
                        </Elif>
                        
                    </If>
                    

                    dxy = section*Tan_Upp - Rtop 
                    xc = .5*(xright+xleft) + dxy 
                    yc = .5*(yright+yleft) 
                    xx = .5*sq2*(xleft+yleft) 
                    yy = .5*sq2*(xright+yright) 
                    len = xx-yy 
                    <Print level="2" fmt="' EXSG: i_str,x,y1,y2,len,xc,yc:',i3,6F12.4"  >
                        i_str,p,yy,xx,len,xc,yc 
                    </Print>
                    
                    <Create block="EHMS"  />
                    <If expr="mod(i_str,2)!=0"  >
                        <Placement y="yc" x="xc" block="EHMS"  >
                            <Rotation alphaz="-45"  />
                        </Placement>
                        
                        <Else  >
                            <Placement y="yc" x="xc" block="EHMS"  >
                                <Rotation alphaz="-45"  />
                                <Rotation ort="X-Y-Z"  />
                            </Placement>
                            
                        </Else>
                        
                    </If>
                    
                </Do>
                
            </If>
            



        </Block>
        
        <Block name="EHMS" comment="is sHower Max Strip"  >
            <Material name="POLYSTYREN"  />
            <Material name="Cpolystyren" isvol="1"  />
            <Attribute for="EHMS" seen="1" serial="cut" colo="2"  />
            <Shape type="TRD1" dz="emxg_Sapex/2" dx2="emxg_Sbase/2" dx1="0" dy="len/2"  />
            <Cut name="CUTGAM" value="0.00008"  />
            <Cut name="CUTELE" value="0.001"  />
            <Cut name="BCUTE" value="0.0001"  />
            <Par name="BIRK1" value="1."  />
            <Par name="BIRK2" value="0.0130"  />
            <Par name="BIRK3" value="9.6E-6"  />
            <Instrument block="EHMS">
                 <Hit meas="birk" nbits="0" min="0" max="10" />
            </Instrument>
        </Block>
        
        <Block name="EXGT" comment="is the G10 layer in the Shower Max"  >
            <Mixture name="g10" dens="1.7"  >
                <Component name="Si" a="28.08" z="14" w="0.6*1*28./60."  />
                <Component name="O" a="16" z="8" w="0.6*2*16./60."  />
                <Component name="C" a="12" z="6" w="0.4*8*12./174."  />
                <Component name="H" a="1" z="1" w="0.4*14*1./174."  />
                <Component name="O" a="16" z="8" w="0.4*4*16./174."  />
            </Mixture>
            
            <Attribute for="EXGT" seen="1" colo="7"  />
            <Shape type="TUBS" rmin="(section-diff)*Tan_Low-1.526" rmax="(section+msecwd-diff)*Tan_Upp" dz="emxg_F4/2" phi2="emcs_PhiMax/emcs_Nsupsec" phi1="emcs_PhiMin/emcs_Nsupsec"  />
            <Cut name="CUTGAM" value="0.00001"  />
            <Cut name="CUTELE" value="0.00001"  />
        </Block>
        
    </Module>
    

</Document>

