<Document file="StarVMC/Geometry/HcalGeo/HcalGeo1.xml">

  <Module name="HcalGeo1" comment=" forward hadronic calorimeter, Proposed Full Geometry, 2016"  >
    <Author name="Prashanth S (KSU), FPS by Akio" />
    <Created date="01/12/2014" />

    <!--
    west   -> +ve Z
    south  -> +ve X
    up/Sky -> +ve Y
    -->


    <CDE>agecom,gcunit,gconst.</CDE>
    <External routine="hcalhit"  />

    <Content>   
      HCMO,     <!-- Mother volume of  Hadronic Calorimeter  --> 
      HTWR,     <!-- 6*6 tower assembly in mother block/Volume, material Lead, with 47*47 fiber optics, which is read by 3*3 PMTs     -->
      HCEL,     <!-- 3*3 cells/pixels in each tower L:has 16*16 fibers  last letter L:Long S:Short-->
      HCES,     <!-- 3*3 cells/pixels in each tower S:has 15*15 fibers -->
      HCLX,     <!-- division of each fiber in to a block, i.e 16*16 divisions for accelerated perfomance of Geant  -->
      HCLY,     <!-- "" --> 
      HCSX,     <!-- "" -->
      HCSY,     <!-- "" -->
      HFIB,     <!-- fibers for Short cell  -->  
      HFIC,     <!-- fibers for Long cell, bcoz of the limitation of STAR AgML -->  
      HACL,      <!-- Aluminum suporting cells at bottom -->     
      <!-- Pre Shower -->
      FPRS,FPLY,FPPB,FPSC,FPBB,
      FLIG,FLBA,FLCO,FPMT,FFEE,
      FLLG,FBLL,FCLL,
      WPPL,WPIS,WPUF,WPUN,WPUS,WPAR
      <!-- End of  Pre Shower -->

    </Content>

    <varlist type="int">
      mmi,mmj,
      nni,nnj,
      ooi,ooj,
      ppi,ppj,
      q1i,q1j,
      q2i,q2j,
      q3i,q3j,
      q4i,q4j,
      flag,flag1,flag2,
      flag3
    </varlist>

    <varlist type="int">
      i,j <!-- temporary variables:-  Towr count -->
      m,l <!-- temporary variables:-  Cell count -->
      <!--  p,q temporary variables:-  Fibr count -->
    </varlist>

    <varlist type="float">
      xtemp,   <!-- temporary variables:- fiber x position -->
      ytemp    <!-- temporary variables:- fiber y position -->
    </varlist>


    <!-- Pre Shower -->
    <!--
    <varlist type="INTEGER"  >
      ChkvSim,iMod,iType,Type,PbPlate
    </varlist>
    -->

    <varlist type="INTEGER"  >
      <!-- i,j,m,flag -->
      k,kk,serN,lr,tb,col,kmod,rot,id,layr,quad,slat(4,3)
      debug,npstype,pstype(20),cpstype(20)
    </varlist>

    <varlist type="REAL"  >
      xx,yy,zz,x1,y1,z1,ztot,rtot,wid,widx,widy,bwid,x0,widL,dx,dy,dz,dxx,dyy,dzz,xxx,yyy,dxxx,dyyy,xpmt,ypmt
      dx1,dy1,dz1,dx2,dy2,dz2,x2,y2,z2,dz3,dx1a,dx1b,dzsb,psdim(20,2)
    </varlist>

    <varlist type="REAL">    ztotsmd,wtotsmd,zsmd,zsmd2,wsmd  </varlist>
    <varlist type="REAL"  >  xsmdh,ysmdh,zsmdh,xsmdv,ysmdv,zsmdv  </varlist>
    <varlist type="REAL"  >  xlcOffSet,BZOffSet  </varlist>
    <varlist type="REAL"  >  basewidth,distancer,xoffFECC,xoffFEDC,xshift  </varlist>
    <varlist type="REAL"  >  xoffFENC,yoffFENC,zoffFENC,zoffFECC  </varlist>
    <varlist type="REAL"  >  tmp(7)  </varlist>


    <varlist   type="INTEGER"> N  </varlist>
    <Parameter name="N" value="12" />

    <varlist type="REAL"> E(N)  </varlist>
    <varlist type="REAL"> rindex_PbG(N)  </varlist>
    <varlist type="REAL"> rindex_SiRub(N)  </varlist>
    <varlist type="REAL"> rindex_PhCath(N)  </varlist>
    <varlist type="REAL"> rindex_Alm(N)  </varlist>
    <varlist type="REAL"> rindex_MuMet(N)  </varlist>
    <varlist type="REAL"> absco_PbG(N)  </varlist>
    <varlist type="REAL"> absco_SiRub(N)  </varlist>
    <varlist type="REAL"> absco_PhCath(N)  </varlist>
    <varlist type="REAL"> absco_Alm(N)  </varlist>
    <varlist type="REAL"> absco_MuMet(N)  </varlist>
    <varlist type="REAL"> effic_PhCath(N)  </varlist>
    <varlist type="REAL"> effic_all(N)  </varlist>



    <varlist type="REAL"  >
      lprs1,lprs2,lprs3,lprs4,pwid,x,y,z,dlg
    </varlist>


    <External routine="FFPDSTEP"  />
    <External routine="FPCTSTEP"  />

    <!-- End of  Pre Shower -->

    <Structure name="mcdt" comment="Mother calorimeter coordinates and dimentions ">
      <!-- x,y,z are body center of HCMO in cave --> 
      <!-- dx,dy,dz are dimintions of HCMO--> 
      <var name="version" type="float"/>
      <var name="x"       type="float"/>
      <var name="y"       type="float"/>
      <var name="z"       type="float"/> 
      <var name="dx"      type="float"/>
      <var name="dy"      type="float"/>
      <var name="dz"      type="float"/>
    </Structure>


    <Structure name="towr" comment="Calorimeter towr dimention">
      <var name="version" type="float"/>
      <var name="dx" 	  type="float"/>
      <var name="dy" 	  type="float"/>
      <var name="dz" 	  type="float"/>
      <var name="nTowerX" type="float"/>
      <var name="nTowerY" type="float"/>
    </Structure>

    <Structure name="cell" comment="Calorimeter pixels dimention">
      <var name="version" type="float"/>
      <var name="dx"      type="float"/>
      <var name="dy"      type="float"/>
      <var name="dz"      type="float"/>
      <var name="nCellX"  type="float"/>  <!--  number of cells in x direction   -->
      <var name="nCellY"  type="float"/>  <!--  number of cells in y direction   --> 
      <var name="nFiberXL" type="float"/> <!--  fibers in (L)ong  cell in X direction-->
      <var name="nFiberYL" type="float"/> <!--  fibers in (L)ong  cell in Y direction-->
      <var name="nFiberXS" type="float"/> <!--  fibers in (S)ong  cell in X direction-->
      <var name="nFiberYS" type="float"/> <!--  fibers in (S)ong  cell in Y direction-->
    </Structure>

    <Structure name="fibr" comment="Scintilating fiber">
      <var name="version"  type="float"/>
      <var name="rmin"     type="float"/> <!-- radius minimum is = Zero    -->
      <var name="rmax"     type="float"/> <!-- radius maximum is = 0.055 cm    -->
      <var name="dz"       type="float"/> <!-- length / 2 = 117 /2 -->
      <var name="startX1"  type="float"/> <!-- Start of fiber position from edge tower x direction   -->
      <var name="startY1"  type="float"/> <!-- Start of fiber position from edge tower y direction   -->
      <var name="startX2"  type="float"/> <!-- Start of fiber position from inside tower x direction   -->
      <var name="startY2"  type="float"/> <!-- Start of fiber position from inside tower y direction   -->
      <var name="stepX"    type="float"/> <!-- distance between two fibers, center to center x direction-->
      <var name="stepY"    type="float"/> <!-- distance between two fibers, center to center y direction-->
    </Structure>


    <!-- Pre Shower -->
    <Structure name="PRSW"  >
      <var name="DBox(3)"  type="float"  />
      <var name="Xoff(4)"  type="float"  />
      <var name="Yoff(4)"  type="float"  />
      <var name="Zoff(4)"  type="float"  />
      <var name="Dz(4)"    type="float"  />
      <var name="DHole"    type="float"  />
      <var name="NType"    type="integer" />
      <var name="NPrs(2)"  type="integer" />
      <var name="DPrs(3)"  type="real" />
      <var name="NSkipV"   type="integer" />
      <var name="NSkipH"   type="integer" />
      <var name="DyCut"    type="real" />
      <var name="DLG(3)"   type="real" />
      <var name="DSIPM(4)" type="real" />
      <var name="DzBbd(4)" type="real" />
      <var name="DxBbd(2)" type="real" />
    </Structure>

    <Structure name="WPFM"  >
      <var name="PoleD(4)" type="float"  />
      <var name="PoleP(3)" type="float"  />
      <var name="IstrD(4)" type="float"  />
      <var name="Ist1P(3)" type="float"  />
      <var name="Ist2P(3)" type="float"  />
      <var name="UstFD(4)" type="float"  />
      <var name="UstFP(3)" type="float"  />
      <var name="UstND(4)" type="float"  />
      <var name="UstNP(3)" type="float"  />
      <var name="UstSD(4)" type="float"  />
      <var name="UstSP(3)" type="float"  />
    </Structure>
    <!-- End of  Pre Shower -->



    <Fill name="mcdt" comment=" Mother Calorimeter">
      <var name="version" value="1.0"       comment="face center of calorimeter"/>
      <var name="x"       value="0.0"       comment="x cdt from center of TPC"/>
      <var name="y"       value="0.0"       comment="y cdt from center of TPC"/>
      <var name="z"       value="777.4"     comment="z cdt from center of TPC"/>  <!-- 778.5 = (dis. from TPC + half of length of calorimeter) = 748.9 + (117/2) + Les's correction(-30)  -->
      <var name="dx"      value="20*10/2."  comment="HCMO width"/>
      <var name="dy"      value="18*10/2."  comment="HCMO height"/>
      <var name="dz"      value="117/2."    comment="HCMO length"/>
    </Fill>


    <Fill name="towr" comment="Structure containing Calorimeter towr dimention">
      <var name="version"  value="1.0"                    comment="towr dimention"/>
      <var name="dx"       value="10.0/2."                comment="towr width"/>
      <var name="dy"       value="10.0/2."                comment="towr height"/>
      <var name="dz"       value="117.0/2."               comment="towr length"/>
      <var name="nTowerX"  value="20" 			  comment="no of tower in X dir"/>
      <var name="nTowerY"  value="18" 			  comment="no of tower in Y dir"/>
    </Fill>

    <Fill name="cell" comment="Structure containing Calorimeter pixels dimention">
      <var name="version"  value="1.0"        comment="pixels dimention"/>
      <var name="dx"       value="3.3/2."     comment="pixels width"/>
      <var name="dy"       value="3.3/2."     comment="pixels height"/>
      <var name="dz"       value="117.0/2."   comment="towr length"/>
      <var name="nCellX"   value="3" 	      comment="no of cells in X dir" />
      <var name="nCellY"   value="3" 	      comment="no of cells in Y dir" />
      <var name="nFiberXL"  value="16"        comment="no fibers in cell 16 fibers"/> 
      <var name="nFiberYL"  value="16"        comment="no fibers in cell 16 fibers"/> 
      <var name="nFiberXS"  value="15"        comment="no fibers in cell 15 fibers"/> 
      <var name="nFiberYS"  value="15"        comment="no fibers in cell 15 fibers"/> 
    </Fill>

    <Fill name="fibr" comment="Scintilating fibes in towers/cells" >
      <var name="version"  value="1.0"      comment="fiber dimention"/>
      <var name="rmin"     value="0.0"      comment="inner radius of fiber"/>
      <var name="rmax"     value="0.055"    comment="outer radius of fiber"/>
      <var name="dz"       value="117.0/2." comment="towr length"/>
      <var name="startX1"  value="0.107"    comment="distance from edge or from one cell boundry to other 1: for first cell " />
      <var name="startY1"  value="0.107"    comment="distance from edge or from one cell boundry to other " />
      <var name="startX2"  value="0.1065"   comment="distance from edge or from one cell boundry to other 2:for 2nd and 3rd cell" />
      <var name="startY2"  value="0.1065"   comment="distance from edge or from one cell boundry to other " />
      <var name="stepX"    value="0.213"    comment="distance between fibers center to center"/>
      <var name="stepY"    value="0.213"    comment="distance between fibers center to center"/>
    </Fill>


    <!-- Pre Shower -->
    <Fill name="PRSW" comment="Pre Shower geometry" >
      <var name="DBox"    value="{225.0,250,22.0}"  />
      <var name="Xoff"    value="{ 1.0,1.0,1.0,1.0}"  />
      <var name="Yoff"    value="{ 0.0,0.0,0.0,0.0}"  />
      <var name="Zoff"    value="{675.64,678.52,690.29,692.22}"  />
      <var name="Dz"      value="{1.0,1.0,0.635,1.0}"  />
      <var name="DHole"   value="20.25"  />
      <var name="NType"   value="2"  />
      <var name="NPrs"    value="{12,9}"  />
      <var name="DPrs"    value="{4.0,5.8,0.05}"  />    ! 1=narrow, 2=wide, 3=gap
      <var name="NSkipV"  value="2" />
      <var name="NSkipH"  value="2" />
      <var name="DyCut"   value="3.0+5.8" />            ! virtical bottom will be shorter due to constrain from floor
      <var name="DLG"     value="{0.3,6.0,1.0}"  />     ! 1=size of SiPM, 2=height for cone, 3=height for base
      <var name="DSIPM"   value="{0.5,3.5,1.0,7.0}"  /> ! 1=thickness for board, 2=width, 3=length, 4=length for FEE board
      <var name="DzBbd"   value="{2.54/8.0,2.54/4.0,2*2.54/4.0,2.54/4.0}" /> ! dz(thickness) of back board
      <var name="DxBbd"   value="{2.54, 2.54+7.0}" />   ! backboard 1=inside extend, 2=outside extend
    </Fill>

    <Fill name="WPFM" comment="West Platform geometry">
      <var name="PoleD" value="{12.0*2.54, 155.5 * 2.54, 12.0*2.54, 1.0}"  />
      <var name="PoleP" value="{72.0*2.54, (-44.36-10-155.5/2)*2.54, 807.72-27*2.54}"  />
      <var name="IstrD" value="{231.0*2.54, 8.0*2.54, 8.0*2.54, 1.0}"  />
      <var name="Ist1P" value="{-8.0*2.54, (-44.36-5.0)*2.54, 807.72-37*2.54}"  />
      <var name="Ist2P" value="{-8.0*2.54, (-44.36-5.0)*2.54, 807.72-17*2.54}"  />
      <var name="UstFD" value="{236.0*2.54, 12*2.54, 4*2.54, 1.0}"  />
      <var name="UstFP" value="{-8.0*2.54, -44.36*2.54, 807.72-(46-2)*2.54}"  />
      <var name="UstND" value="{4*2.54, 12.0*2.54, (46-4)*2.54, 1.0}"  />
      <var name="UstNP" value="{-(118-2+8)*2.54, -44.36*2.54, 807.72-(46-4)*2.54/2}"  />
      <var name="UstSD" value="{4*2.54, 12.0*2.54, (46-4)*2.54, 1.0}"  />
      <var name="UstSP" value="{+(118-2-8)*2.54, -44.36*2.54, 807.72-(46-4)*2.54/2}"  />
    </Fill>

    <!-- End of  Pre Shower -->

    <Use struct="mcdt" select="version" value="1.0" />
    <Use struct="towr" select="version" value="1.0" />
    <Use struct="cell" select="version" value="1.0" />
    <Use struct="fibr" select="version" value="1.0" />

    <Create    block="HCMO"/>
    <Placement block="HCMO" in="CAVE" x="mcdt_x" y="mcdt_y" z="mcdt_z"/> 

    <!-- Pre Shower -->
    <Create    block="FPRS"  />
    <Placement block="FPRS" in="CAVE" konly="MANY" group="WestRefSys" x="0.0" y="0.0" z="PRSW_Zoff(1)-PRSW_DSIPM(1)+PRSW_Dbox(3)/2.0" />

    <Create    block="WPPL"  />
    <Placement block="WPPL" in="CAVE" group="WestRefSys" x="+WPFM_PoleP(1)" y="WPFM_PoleP(2)" z="WPFM_PoleP(3)" />
    <Placement block="WPPL" in="CAVE" group="WestRefSys" x="-WPFM_PoleP(1)" y="WPFM_PoleP(2)" z="WPFM_PoleP(3)" />

    <Create    block="WPIS"  />
    <Placement block="WPIS" in="CAVE" group="WestRefSys" x="WPFM_Ist1P(1)" y="WPFM_Ist1P(2)" z="WPFM_Ist1P(3)" />
    <Placement block="WPIS" in="CAVE" group="WestRefSys" x="WPFM_Ist2P(1)" y="WPFM_Ist2P(2)" z="WPFM_Ist2P(3)" />

    <Create    block="WPUF"  />
    <Placement block="WPUF" in="CAVE" group="WestRefSys" x="+WPFM_UstFP(1)" y="WPFM_UstFP(2)" z="WPFM_UstFP(3)" />
    <Create    block="WPUN"  />
    <Placement block="WPUN" in="CAVE" group="WestRefSys" x="+WPFM_UstNP(1)" y="WPFM_UstNP(2)" z="WPFM_UstNP(3)" />
    <Create    block="WPUS"  />
    <Placement block="WPUS" in="CAVE" group="WestRefSys" x="+WPFM_UstSP(1)" y="WPFM_UstSP(2)" z="WPFM_UstSP(3)" />
    <!-- End of  Pre Shower -->



    <Volume name="HCMO" comment="Mother Calorimeter">
      <Material  name="Air"      /> 
      <Medium    name="Standard" />

      <Attribute seen="0" colo="3" />

      <Shape type="Box" dx="mcdt_dx" dy="mcdt_dy" dz="mcdt_dz" />


      mmi=0;
      mmj=4;

      nni=0;
      nnj=13;

      ooi=16;
      ooj=1;

      ppi=16;
      ppj=16;

      q1i=9;q1j=8;
      q2i=9;q2j=9;
      q3i=10;q3j=8;
      q4i=10;q4j=9;

      <For var="i" from="0" to="towr_nTowerX-1">
	<For var="j" from="0" to="towr_nTowerY-1">

	  <!--For strip all for corners  -->
	  flag1 = ( (i.eq.mmi) .and. (j.lt.mmj) ) .or. ( (i.eq.nni) .and. (j.gt.nnj) ) .or. ( (i.eq.ooi) .and. (j.lt.ooj) ) .or. ( (i.eq.ppi) .and. (j.gt.ppj) ) ;  
	  <!-- To remove center 4 towers --> 
	  flag2 = ( (i.eq.q1i  ) .and. ( j.eq.q1j) ) .or. ( (i.eq.q2i  ) .and. ( j.eq.q2j) )  .or. ( (i.eq.q3i  ) .and. ( j.eq.q3j) )  .or. ( (i.eq.q4i  ) .and. ( j.eq.q4j) ); 
	  flag = flag1 + flag2;

	  <!-- For supporting blockes -->
	  flag3 = ( (i.eq.mmi) .and. (j.lt.mmj) ) .or. ( (i.eq.ooi) .and. (j.lt.ooj) ) ; 

	  <If expr="(flag.eq.0) ">
	    <Create block="HTWR" />
	    <Placement block="HTWR" x="-(((towr_nTowerX/2)*towr_dx*2)-towr_dx)+(i*towr_dx*2)" y="-(((towr_nTowerY/2)*towr_dy*2)-towr_dy)+(j*towr_dy*2)" z="0.0" />
	  </If>

	  <If expr="(flag3.eq.1) ">
	    <Create block="HACL" />
	    <Placement block="HACL" x="-(((towr_nTowerX/2)*towr_dx*2)-towr_dx)+(i*towr_dx*2)" y="-(((towr_nTowerY/2)*towr_dy*2)-towr_dy)+(j*towr_dy*2)" z="0.0" />
	  </If>

	</For>

	<If expr="i.eq.mmi">
	  mmi=mmi+1;
	  mmj=mmj-1;
	</If>

	<If expr="i.eq.nni">
	  nni=nni+1;
	  nnj=nnj+1;
	</If>

	<If expr="i.eq.ooi">
	  ooi=ooi+1;
	  ooj=ooj+1;
	</If>

	<If expr="i.eq.ppi">
	  ppi=ppi+1;
	  ppj=ppj-1;
	</If>


      </For>



    </Volume>



    <Volume name="HTWR" comment="Towrs  of Calorimeter">
      <Material name="Lead"  />
      <Medium name="standard"  />
      <Attribute seen="1" colo="3" />
      <Shape type="Box" dx="towr_dx" dy="towr_dy" dz="towr_dz" />

      xtemp=fibr_startX1;
      <For var="m" from="0" to="cell_nCellX-1">
	ytemp=fibr_startY1;
	<For var="l" from="0" to="cell_nCellY-1">

	  <!-- Short and Long cell assembly configaration view from +z towards STAR
	  16  16  15
	  16  15  16
	  15  16  16
	  -->

	  <!-- <Info format="at center {1.1f}">m</Info> -->

	  <If expr="m.eq.l">
	    <Create block="HCES" />
	    <Placement block="HCES" x="-3.33+(3.33*m)" y="-3.33+(l*3.33)" z="0.0" />
	    <Else>
	      <Create block="HCEL" />
	      <Placement block="HCEL" x="-3.33+(3.33*m)" y="-3.33+(l*3.33)" z="0.0" />
	    </Else>
	  </If>
	  ytemp=fibr_startY2;

	</For>
	xtemp=fibr_startX2;
      </For>

    </Volume>


    <Volume name="HCES" comment="3*3 cell in tower, HCES has 15*15 fibers">
      <Material name="Lead"            /> <!-- copy parameters -->
      <Material name="Lead"  isvol="5" /> <!-- save copy with new name and declare active -->
      <Attribute seen="0" colo="3" />
      <Shape     type="Box" dx="cell_dx" dy="cell_dy" dz="cell_dz" />

      <Create    block="HCSX" />

      <Instrument block="HCES" comment="Hit declaration for Pb">
	<Hit meas="hcal" opts="S" nbits="0" min="0" max="100.0"/>
	<Hit meas="elos" opts="S" nbits="0" min="0" max="100.0"  />
	<Hit meas="birk" opts="S" nbits="0" min="0" max="100.0"  />
      </Instrument>

    </Volume>

    <Volume name="HCEL" comment="3*3 cell in tower, HCES has 16*16 fibers">
      <Material name="Lead"            /> <!-- copy paramters -->
      <Material name="Lead"  isvol="5" /> <!-- save copy with new name and declare active -->
      <Attribute seen="0" colo="3" />
      <Shape type="Box" dx="cell_dx" dy="cell_dy" dz="cell_dz" />

      <Create    block="HCLX" />
      <Instrument block="HCEL" comment="Hit declaration for Pb">
	<Hit meas="hcal" opts="S" nbits="0" min="0" max="100.0"/>
	<Hit meas="elos" opts="S" nbits="0" min="0" max="100.0"  />
	<Hit meas="birk" opts="S" nbits="0" min="0" max="100.0"  />
      </Instrument>

    </Volume>




    <Volume name="HCSX" comment="3*3 cell in tower x divisions">
      <Material name="Lead"  isvol="0" />
      <Attribute seen="0" colo="3" />
      <Shape type= "Division" iaxis = "1" ndiv  = "cell_nFiberXS" />
      <Create block="HCSY" />
    </Volume>


    <Volume name="HCSY" comment="3*3 cell in tower y divisions">
      <Material name="Lead"  isvol="0" />
      <Attribute seen="0" colo="3" />
      <Shape type  = "Division" iaxis = "2" ndiv  = "cell_nFiberYS" />
      <Create block="HFIB" />  
      <Placement block="HFIB" x="0" y="0" z="0.0" />
    </Volume>


    <Volume name="HCLX" comment="3*3 cell in tower x divisions">
      <Material name="Lead"  isvol="0" />
      <Attribute seen="0" colo="3" />
      <Shape type  = "Division" iaxis = "1" ndiv  = "cell_nFiberXL" />
      <Create block="HCLY" />
    </Volume>


    <Volume name="HCLY" comment="3*3 cell in tower y divisions">
      <Material name="Lead"  isvol="0" />
      <Attribute seen="0" colo="3" />
      <Shape type  = "Division" iaxis = "2" ndiv  = "cell_nFiberYL" />
      <Create block="HFIC" />  
      <Placement block="HFIC" x="0" y="0" z="0.0" />
    </Volume>

    <Volume name="HFIB" comment="fiber in cells">
      <Material name="Polystyren"  />
      <Material name="SensPoly"  isvol="1" />
      <Medium name="standard"  />
      <Attribute seen="0" colo="3" />
      <Shape type="TUBE" rmin="fibr_rmin" rmax="fibr_rmax" dz="fibr_dz" />

      <!--
      <Instrument block="HCES" comment="Hit declaration for Pb">	
	<Hit meas="hcal" opts="C" nbits="0" min="0" max="100.0" /> 
	<Hit meas="elos" opts="C" nbits="0" min="0" max="100.0"  />
	<Hit meas="birk" opts="C" nbits="0" min="0" max="100.0"  />
      </Instrument>
      -->

    </Volume>

    <Volume name="HFIC" comment="fiber in cells">

      <Material name="Polystyren"  />
      <Material name="SensPoly"  isvol="1" />
      <Medium name="standard"  />
      <Attribute seen="0" colo="3" />
      <Shape type="TUBE" rmin="fibr_rmin" rmax="fibr_rmax" dz="fibr_dz" />

      <!-- Attach hits to volume HCES.  Hits are cumulative -->
      <!--
      <Instrument block="HCEL" comment="Hit declaration for Pb">	
	<Hit meas="hcal" opts="C" nbits="0" min="0" max="100.0" />
	<Hit meas="elos" opts="C" nbits="0" min="0" max="100.0"  />
	<Hit meas="birk" opts="C" nbits="0" min="0" max="100.0"  />
      </Instrument>
      -->

    </Volume>

    <Volume name="HACL" comment=" Aluminum suporting cells">
      <Material name="Aluminium" isvol="0"/>
      <Medium name="standard" />
      <Attribute seen="1" colo="2" />
      <Shape type="Box" dx="towr_dx" dy="towr_dy" dz="towr_dz" />
    </Volume>


    <!-- Pre Shower -->
    <Block name="FPRS" comment="is box for plastic schinti FMS pre-shower detectors"  >

      <Material  name="Air"  />
      <Medium    name="standard"  />
      <Attribute for="FPRS" 
	seen="0" 
	colo="2"  
	/>

      <Shape type="PGON" 
	phi1="45" dphi="360" npdiv="4" nz="2" 
	zi="{-PRSW_DBox(3)/2.0,PRSW_DBox(3)/2.0}" 
	rmn="{PRSW_DHole - PRSW_DxBbd(1),PRSW_DHole - PRSW_DxBbd(1)}" 
	rmx="{PRSW_DBox(1)/2.0,PRSW_DBox(1)/2.0}" 
	/>  

      debug=0	     
      <If expr="debug.ge.1" > 
	npstype=0 
	cpstype(1)=1
	cpstype(2)=2
	cpstype(3)=6
	cpstype(4)=3
	cpstype(5)=4
	cpstype(6)=7
	cpstype(7)=5
	cpstype(8)=8
	<Export language="Mortran"> open(11,file='fpsgeom.txt',status='REPLACE')</Export>
      </If>

      <!-- .......................................................... First Layer -->
      serN=1 
      dx=PRSW_DBox(1)/2.0
      dy=PRSW_DBox(2)/2.0
      dz=PRSW_Dz(1)/2.0+PRSW_DzBbd(1)/2.0+PRSW_DSIPM(1)/2.0
      zz=-PRSW_Dbox(3)/2.0+dz
      <Create    block="FPLY"  />
      <Placement block="FPLY" in="FPRS" z="zz" konly="MANY"/>
      <!-- ........................................................  Second Layer -->
      serN=2 
      dx=PRSW_DBox(1)/2.0
      dy=PRSW_DBox(2)/2.0
      dz=PRSW_Dz(2)/2.0+PRSW_DzBbd(2)/2.0+PRSW_DSIPM(1)/2.0
      zz=-PRSW_Dbox(3)/2.0+dz+PRSW_Zoff(2)-PRSW_Zoff(1)
      <Create    block="FPLY"  />
      <Placement block="FPLY" in="FPRS" z="zz" konly="MANY" />

      <!-- .......................................................... Third Layer -->
      serN=3 
      dx=PRSW_DBox(1)/2.0
      dy=PRSW_DBox(2)/2.0
      dz=PRSW_Dz(3)/2.0+PRSW_DzBbd(3)/2.0
      zz=-PRSW_Dbox(3)/2.0+PRSW_DSIPM(1)+dz-PRSW_DzBbd(3)/2.0+PRSW_Zoff(3)-PRSW_Zoff(1)
      dzsb = PRSW_Dz(3)/2.0+PRSW_DzBbd(3)/4.0
      <Create     block="FPLY"  />
      <Placement  block="FPLY" in="FPRS" z="zz" konly="MANY" />

      <!-- ......................................................... Fourth Layer -->
      serN=4 
      dx=PRSW_DBox(1)/2.0
      dy=PRSW_DBox(2)/2.0
      dz=PRSW_Dz(4)/2.0+PRSW_DzBbd(4)/2.0+PRSW_DSIPM(1)/2.0
      zz=-PRSW_Dbox(3)/2.0+dz+PRSW_DSIPM(1)+PRSW_Zoff(4)-PRSW_Zoff(1)-PRSW_DzBbd(4) 
      <Create     block="FPLY"  />
      <Placement  block="FPLY" in="FPRS" z="zz" konly="MANY" />
      <!--
      <If expr="debug.ge.1" > 
	<Export language="Mortran"> open(10,file='prs.txt',status='REPLACE')</Export>
	k=0
	<Do var="i" from="1" to="npstype" >
	  <Do var="j" from="1" to="npstype" >
	    <If expr="i.eq.cpstype(j)">
	      <Export language="Mortran"> 
		write(*,'(A5,A1,I5,F8.2,F8.2,F8.2)') 'Type=',char(ichar('A')+cpstype(j)-1),pstype(j),psdim(j,1)*2,psdim(j,2)*2,1.0
		write(10,'(A5,A1,I5,F8.2,F8.2,F8.2)') 'Type=',char(ichar('A')+cpstype(j)-1),pstype(j),psdim(j,1)*2,psdim(j,2)*2,1.0
	      </Export>
	      k=k+pstype(j)
	    </If>
	  </Do>		 
	</Do>
	<Export language="Mortran"> write(10,*) 'Total=',k </Export> 
	<Export language="Mortran"> close(10)</Export>
	<Export language="Mortran"> close(11)</Export>
      </If>
      -->
    </Block>

    <!--                                                    Preshower Layer:  FPLY -->
    <Block name="FPLY" comment="is a layer of FMS Preshower"  >         
      <Material  name="Air"  />
      <Medium    name="standard"  />
      <Attribute for="FPLY" seen="0" colo="3" serial="serN" />
      <!-- <Shape type="BOX" dx="dx" dy="dy" dz="dz" /> -->
      <Shape type="PGON"
	phi1="45" dphi="360" npdiv="4" nz="2"
	zi="{-dz,dz}"
	rmn="{PRSW_DHole - PRSW_DxBbd(1),PRSW_DHole - PRSW_DxBbd(1)}"
	rmx="{PRSW_DBox(1)/2.0,PRSW_DBox(1)/2.0}"
	/>

      lprs1=PRSW_NPrs(1)*(PRSW_DPrs(1)+PRSW_DPrs(3))                       <!-- width of narrow section -->
      lprs2=PRSW_NPrs(2)*(PRSW_DPrs(2)+PRSW_DPrs(3))+lprs1                 <!-- width of narrow+wide section --> 
      lprs3=(PRSW_NPrs(2)-PRSW_NSkipH)*(PRSW_DPrs(2)+PRSW_DPrs(3))+lprs1   <!-- width of narrow+wide for bottom horizontal -->
      lprs4=(PRSW_NPrs(1)-PRSW_NSkipV)*(PRSW_DPrs(1)+PRSW_DPrs(3))+PRSW_NPrs(2)*(PRSW_DPrs(2)+PRSW_DPrs(3))
      <!-- width of narrow+wide for bottom vertical -->
      dlg=(PRSW_DLG(2)+PRSW_DLG(3)+PRSW_DSIPM(1))/2.0

      k   = 0
      dzz = PRSW_DZ(serN)/2.0
      <If expr="serN.eq.3">               ! Pb in middle, back plate in front and back
	z1=0
	z2=0
	<Elif expr="serN.eq.4">             ! back board first for layer3
	  z1=-dz+PRSW_DzBbd(serN)+dzz       ! z for schinti
	  z2=-dz+PRSW_DzBbd(serN)/2.0       ! z for back board
	</Elif>
	<Else>                              ! back board 2nd for layer1,2
	  z1=-dz+PRSW_DSIPM(1)+dzz          ! z for schinti
	  z2=-dz+PRSW_DSIPM(1)+dzz*2+PRSW_DzBbd(serN)/2.0 ! z for back board
      </Else></If> 
      z = PRSW_Zoff(serN)

      <!-- Blocks can be created once.  Sized at position time -->
      <Create block="FPSC" />
      <Create block="FLIG" />
      <Create block="FLLG" />
      <Create block="WPAR" />
      <Create block="FPBB" />
      <Create block="FPPB" />

      <If expr="debug.ge.1 .and. serN.eq.1"> <Export language="Mortran"> open(1,file='prs1map.txt',status='REPLACE')</Export></If>
      <If expr="debug.ge.1 .and. serN.eq.2"> <Export language="Mortran"> open(2,file='prs2map.txt',status='REPLACE')</Export></If>
      <If expr="debug.ge.1 .and. serN.eq.3"> <Export language="Mortran"> open(3,file='prsCmap.txt',status='REPLACE')</Export></If>
      <If expr="debug.ge.1 .and. serN.eq.4"> <Export language="Mortran"> open(4,file='prs3map.txt',status='REPLACE')</Export></If>

      <If expr="serN.le.2" >
	layr=serN
	<Else>
	  layr=serN-1
      </Else> </If>

      <If expr="serN.eq.1"> <Then> <!-- vertical plane --> 
	  <Do var="lr" from="1" to="2"  > <!-- left and right half -->
	    <Do var="tb" from="1" to="2"> <!-- top and bottom quad -->
	      x=0.0
	      quad=(lr-1)*2+tb
	      slat(quad,layr)=0
	      <Do var="j" from="1" to="2"> <!-- narrow/wide -->
		<Do var="i" from="1" to="PRSW_NPrs(j)"> <!-- cell -->
		  dxx = PRSW_DPrs(j)/2.0
		  x = x + dxx + PRSW_DPrs(3)/2.0
		  <If expr="tb.eq.1"> 
		    pwid=lprs2
		    <Else>
		      pwid=lprs3-PRSW_DyCut
		  </Else></If>
		  <If expr="x.le.PRSW_DHole">
		    dyy = (pwid-PRSW_DHole)/2.0
		    y   = dyy+PRSW_DHole
		    <Else>
		      dyy = pwid/2.0
		      y   = dyy
		  </Else></If>
		  yy=y+dyy+dlg
		  <If expr="tb.eq.1"> rot=0</If>
		  <If expr="tb.eq.2"> y=-y; yy=-yy; rot=180</If>
		  <If expr="lr.eq.1"> xx=+x+PRSW_Xoff(serN)</If>
		  <If expr="lr.eq.2"> xx=-x-PRSW_Xoff(serN)</If>
		  y=y+PRSW_Yoff(serN); yy=yy+PRSW_Yoff(serN);
		  <If expr="tb.eq.1 .or. j.eq.2 .or. i.gt.PRSW_NSkipV">
		    <If expr="debug.ge.1"> 
		      k   = k+1
		      slat(quad,layr)=slat(quad,layr)+1
		      id=(quad-1)*3*21+(layr-1)*21+(slat(quad,layr)-1)
		      flag=0
		      <Do var="kk" from="1" to="npstype"> 
			<If expr="(psdim(kk,1).eq.dxx.and.psdim(kk,2).eq.dyy).or.(psdim(kk,1).eq.dyy.and.psdim(kk,2).eq.dxx)">
			  flag=kk
			  pstype(kk)=pstype(kk)+1
			</If>
		      </Do>
		      <If expr="flag.eq.0">
			npstype=npstype+1
			flag=npstype
			pstype(flag)=1
			<If expr="dxx.gt.dyy">
			  psdim(npstype,1)=dyy
			  psdim(npstype,2)=dxx
			  <Else>
			    psdim(npstype,1)=dxx
			    psdim(npstype,2)=dyy
			</Else></If>
		      </If>
		      <!--
		      <Export language="Mortran"> 
			write(serN,'(I2,I3,F8.2,F8.2,F8.2,F8.2,F8.2,F8.2,2X,A1)') serN,k,dxx*2,dyy*2,dzz*2,xx,y,z,char(ichar('A')+cpstype(flag)-1)
			write(11,'(I3,I2,I2,I3,F8.2,F8.2,F8.2,F8.2,F8.2,F8.2)') id,quad,layr,slat(quad,layr),dxx*2,dyy*2,dzz*2,xx,y,z
		      </Export> 
		      -->
		    </If>
		    <Placement block="FPSC" x="xx" y="y" z="z1" dx="dxx" dy="dyy" dz="dzz" /> 
		    <Placement block="FLIG" x="xx" y="yy" z="z1-PRSW_DSIPM(1)/2.0" if="j.eq.1"> <Rotation alphax="-90" /> <Rotation alphaz="rot" /></Placement>
		    <Placement block="FLLG" x="xx" y="yy" z="z1-PRSW_DSIPM(1)/2.0" if="j.eq.2"> <Rotation alphax="-90" /> <Rotation alphaz="rot" /></Placement>
		  </If>
		  x = x + dxx
		</Do>
	      </Do>
	    </Do>
	  </Do>
	</Then> 
	<Elif expr="serN.eq.2 .or. serN.eq.4"> <!-- horizontal plane --> 
	  <Do var="lr" from="1" to="2"  > <!-- left and right half -->  
	    <Do var="tb" from="1" to="2"> <!-- top and bottom quad -->
	      y=0.0
	      quad=(lr-1)*2+tb
	      slat(quad,layr)=0
	      <Do var="j" from="1" to="2"> <!-- narrow/wide -->
		<Do var="i" from="1" to="PRSW_NPrs(j)"> <!-- cell -->
		  dyy = PRSW_DPrs(j)/2.0		     
		  y = y + dyy + PRSW_DPrs(3)/2.0
		  pwid=lprs2
		  <If expr="y.le.PRSW_DHole">
		    dxx = (pwid-PRSW_DHole)/2.0
		    x   = dxx+PRSW_DHole
		    <Else>
		      <If expr="tb.eq.1">
			dxx = pwid/2.0
			x   = dxx
			<Else>
			  dxx = lprs4/2.0
			  x   = dxx+2*PRSW_DPrs(1)
		      </Else></If>
		  </Else></If> 
		  xx=x+dxx+dlg
		  <If expr="tb.eq.1"> yy=+y; </If>
		  <If expr="tb.eq.2"> yy=-y; </If>
		  <If expr="lr.eq.1"> x=+x+PRSW_Xoff(serN); xx=+xx+PRSW_Xoff(serN); rot=-90</If>
		  <If expr="lr.eq.2"> x=-x-PRSW_Xoff(serN); xx=-xx-PRSW_Xoff(serN); rot=90</If>
		  yy=yy+PRSW_Yoff(serN);
		  <If expr="tb.eq.1 .or. j.eq.1 .or. i.le.PRSW_NPrs(j)-PRSW_NSkipH">
		    <If expr="debug.ge.1"> 
		      k   = k+1
		      slat(quad,layr)=slat(quad,layr)+1
		      id=(quad-1)*3*21+(layr-1)*21+(slat(quad,layr)-1)
		      flag=0
		      <Do var="kk" from="1" to="npstype"> 
			<If expr="(psdim(kk,1).eq.dxx.and.psdim(kk,2).eq.dyy).or.(psdim(kk,1).eq.dyy.and.psdim(kk,2).eq.dxx)">
			  flag=kk
			  pstype(kk)=pstype(kk)+1
			</If>
		      </Do>
		      <If expr="flag.eq.0">
			npstype=npstype+1
			flag=npstype
			pstype(flag)=1
			<If expr="dxx.gt.dyy">
			  psdim(npstype,1)=dyy
			  psdim(npstype,2)=dxx
			  <Else>
			    psdim(npstype,1)=dxx
			    psdim(npstype,2)=dyy
			</Else></If>
		      </If>		  
		      <!--
		      <Export language="Mortran"> 
			write(serN,'(I2,I3,F8.2,F8.2,F8.2,F8.2,F8.2,F8.2,2X,A1)') serN,k,dxx*2,dyy*2,dzz*2,x,yy,z,char(ichar('A')+cpstype(flag)-1)
			write(11,'(I3,I2,I2,I3,F8.2,F8.2,F8.2,F8.2,F8.2,F8.2)') id,quad,layr,slat(quad,layr),dxx*2,dyy*2,dzz*2,xx,y,z
		      </Export>
		      -->
		    </If>
		    <Placement block="FPSC" x="x"  y="yy" z="z1" dx="dxx" dy="dyy" dz="dzz" /> 
		    <Placement block="FLIG" x="xx" y="yy" z="z1-PRSW_DSIPM(1)/2.0" if="j.eq.1.and.serN.eq.2" > <Rotation alphax="-90" /> <Rotation alphaz="rot" /></Placement>
		    <Placement block="FLLG" x="xx" y="yy" z="z1-PRSW_DSIPM(1)/2.0" if="j.eq.2.and.serN.eq.2" > <Rotation alphax="-90" /> <Rotation alphaz="rot" /></Placement>
		    <Placement block="FLIG" x="xx" y="yy" z="z1+PRSW_DSIPM(1)/2.0" if="j.eq.1.and.serN.eq.4" > <Rotation alphax="90" /> <Rotation alphaz="-rot" /></Placement>
		    <Placement block="FLLG" x="xx" y="yy" z="z1+PRSW_DSIPM(1)/2.0" if="j.eq.2.and.serN.eq.4" > <Rotation alphax="90" /> <Rotation alphaz="-rot" /></Placement>
		  </If>
		  y = y + dyy
		</Do>
	      </Do>
	    </Do>
	  </Do>
      </Elif></If>	   
      <If expr="debug.ge.1"> <Export language="Mortran"> close(serN) </Export> </If>

      <!-- back plates and conveter -->
      dz1=PRSW_DzBbd(serN)/2.0
      dz3=PRSW_Dz(3)+PRSW_DzBbd(3)
      <!-- above beam pipe -->
      dx1=(PRSW_DHole-PRSW_DxBbd(1))/2.0
      dy1=(lprs2-PRSW_DHole+PRSW_DxBbd(1)+PRSW_DxBbd(2))/2.0
      x2=PRSW_xoff(serN)+dx1
      y2=PRSW_DHole-PRSW_DxBbd(1)+dy1
      dxx=dx1; dyy=dy1;
      <Placement block="FPBB" x="x2"  y="y2" z="z2"      dx="dx1" dy="dy1" dz="dz1"               if="serN.ne.3" />
      <Placement block="FPBB" x="-x2" y="y2" z="z2"      dx="dx1" dy="dy1" dz="dz1"               if="serN.ne.3" />
      <Placement block="FPBB" x="x2"  y="y2" z="z2-dzsb" dx="dx1" dy="dy1" dz="PRSW_DzBbd(3)/4.0" if="serN.eq.3" />
      <Placement block="FPPB" x="x2"  y="y2" z="z2"      dx="dx1" dy="dy1" dz="PRSW_Dz(3)/2.0"    if="serN.eq.3" />	   
      <Placement block="FPBB" x="x2"  y="y2" z="z2+dzsb" dx="dx1" dy="dy1" dz="PRSW_DzBbd(3)/4.0" if="serN.eq.3" />	   
      <Placement block="FPBB" x="-x2" y="y2" z="z2-dzsb" dx="dx1" dy="dy1" dz="PRSW_DzBbd(3)/4.0" if="serN.eq.3" />
      <Placement block="FPPB" x="-x2" y="y2" z="z2"      dx="dx1" dy="dy1" dz="PRSW_Dz(3)/2.0"    if="serN.eq.3" />
      <Placement block="FPBB" x="-x2" y="y2" z="z2+dzsb" dx="dx1" dy="dy1" dz="PRSW_DzBbd(3)/4.0" if="serN.eq.3" />	   

      <!-- top far -->
      dx2=(lprs2-PRSW_DHole+PRSW_DxBbd(1)+PRSW_DxBbd(2))/2.0                    
      dy2=(lprs2+PRSW_DxBbd(2))/2.0
      x2=PRSW_xoff(serN)+dx1*2+dx2
      y2=dy2                                                                                                                           
      dxx=dx2; dyy=dy2;
      <Placement block="FPBB" x="x2"  y="y2" z="z2"      dx="dx2" dy="dy2" dz="dz1" if="serN.ne.3" />
      <Placement block="FPBB" x="-x2" y="y2" z="z2"      dx="dx2" dy="dy2" dz="dz1" if="serN.ne.3" />	   
      <Placement block="FPBB" x="x2"  y="y2" z="z2-dzsb" dx="dx2" dy="dy2" dz="PRSW_DzBbd(3)/4.0" if="serN.eq.3" />
      <Placement block="FPPB" x="x2"  y="y2" z="z2"      dx="dx2" dy="dy2" dz="PRSW_Dz(3)/2.0"    if="serN.eq.3" />	   
      <Placement block="FPBB" x="x2"  y="y2" z="z2+dzsb" dx="dx2" dy="dy2" dz="PRSW_DzBbd(3)/4.0" if="serN.eq.3" />	   
      <Placement block="FPBB" x="-x2" y="y2" z="z2-dzsb" dx="dx2" dy="dy2" dz="PRSW_DzBbd(3)/4.0" if="serN.eq.3" />
      <Placement block="FPPB" x="-x2" y="y2" z="z2"      dx="dx2" dy="dy2" dz="PRSW_Dz(3)/2.0"    if="serN.eq.3" />
      <Placement block="FPBB" x="-x2" y="y2" z="z2+dzsb" dx="dx2" dy="dy2" dz="PRSW_DzBbd(3)/4.0" if="serN.eq.3" />	   

      <!-- below beam pipe -->
      dx1a=(PRSW_DHole-PRSW_DxBbd(1)-PRSW_NSkipV*PRSW_Dprs(1))/2.0
      dx1b=(PRSW_DHole-PRSW_DxBbd(1))/2.0
      <If expr="serN.le.4">
	dx1=dx1a
	x2=PRSW_xoff(serN)+PRSW_NSkipV*PRSW_Dprs(1)+dx1
	<Else>
	  dx1=dx1b
	  x2=PRSW_xoff(serN)+dx1
      </Else></If>
      dy1=(lprs3-PRSW_DHole-PRSW_DyCut+PRSW_DxBbd(1)+PRSW_DxBbd(2))/2.0
      y2=PRSW_DHole-PRSW_DxBbd(1)+dy1
      dxx=dx1; dyy=dy1;
      <Placement block="FPBB" x="x2"  y="-y2" z="z2" dx="dx1" dy="dy1" dz="dz1" if="serN.ne.3" />
      <Placement block="FPBB" x="-x2" y="-y2" z="z2" dx="dx1" dy="dy1" dz="dz1" if="serN.ne.3" />
      <Placement block="FPBB" x="x2"  y="-y2" z="z2-dzsb" dx="dx1" dy="dy1" dz="PRSW_DzBbd(3)/4.0" if="serN.eq.3" />
      <Placement block="FPPB" x="x2"  y="-y2" z="z2"      dx="dx1" dy="dy1" dz="PRSW_Dz(3)/2.0"    if="serN.eq.3" />	   
      <Placement block="FPBB" x="x2"  y="-y2" z="z2+dzsb" dx="dx1" dy="dy1" dz="PRSW_DzBbd(3)/4.0" if="serN.eq.3" />	   
      <Placement block="FPBB" x="-x2" y="-y2" z="z2-dzsb" dx="dx1" dy="dy1" dz="PRSW_DzBbd(3)/4.0" if="serN.eq.3" />
      <Placement block="FPPB" x="-x2" y="-y2" z="z2"      dx="dx1" dy="dy1" dz="PRSW_Dz(3)/2.0"    if="serN.eq.3" />
      <Placement block="FPBB" x="-x2" y="-y2" z="z2+dzsb" dx="dx1" dy="dy1" dz="PRSW_DzBbd(3)/4.0" if="serN.eq.3" />	   

      <!-- bottom far -->
      <If expr="serN.le.2"> 
	dx2=(lprs2-PRSW_DHole+PRSW_DxBbd(1)+PRSW_DxBbd(2))/2.0
	<Else>
	  dx2=(lprs2-PRSW_DHole+PRSW_DxBbd(1)+PRSW_DxBbd(2))/2.0                    
      </Else></If>
      dy2=(lprs3-PRSW_DyCut+PRSW_DxBbd(2))/2.0
      x2=PRSW_xoff(serN)+dx1b*2+dx2
      y2=dy2                                                                                                                           
      dxx=dx2; dyy=dy2;
      <Placement block="FPBB" x="x2"  y="-y2" z="z2" dx="dx2" dy="dy2" dz="dz1" if="serN.ne.3" />
      <Placement block="FPBB" x="-x2" y="-y2" z="z2" dx="dx2" dy="dy2" dz="dz1" if="serN.ne.3" />
      <Placement block="FPBB" x="x2"  y="-y2" z="z2-dzsb" dx="dx2" dy="dy2" dz="PRSW_DzBbd(3)/4.0" if="serN.eq.3" />
      <Placement block="FPPB" x="x2"  y="-y2" z="z2"      dx="dx2" dy="dy2" dz="PRSW_Dz(3)/2.0"    if="serN.eq.3" />	   
      <Placement block="FPBB" x="x2"  y="-y2" z="z2+dzsb" dx="dx2" dy="dy2" dz="PRSW_DzBbd(3)/4.0" if="serN.eq.3" />	   
      <Placement block="FPBB" x="-x2" y="-y2" z="z2-dzsb" dx="dx2" dy="dy2" dz="PRSW_DzBbd(3)/4.0" if="serN.eq.3" />
      <Placement block="FPPB" x="-x2" y="-y2" z="z2"      dx="dx2" dy="dy2" dz="PRSW_Dz(3)/2.0"    if="serN.eq.3" />
      <Placement block="FPBB" x="-x2" y="-y2" z="z2+dzsb" dx="dx2" dy="dy2" dz="PRSW_DzBbd(3)/4.0" if="serN.eq.3" />	   

      <!-- <Export language="Mortran"> write(*,*) 'Done serN=',serN</Export>	-->   
    </Block>

    <Block name="FPBB" comment="is the G10 back board"  >
      <Mixture name="g10" dens="1.7"  >
	<Component name="Si" a="28.08" z="14" w="0.6*1*28./60."  />
	<Component name="O" a="16" z="8" w="0.6*2*16./60."  />
	<Component name="C" a="12" z="6" w="0.4*8*12./174."  />
	<Component name="H" a="1" z="1" w="0.4*14*1./174."  />
	<Component name="O" a="16" z="8" w="0.4*4*16./174."  />
      </Mixture>
      <Attribute for="FPBB" seen="1" colo="7"  />
      <Shape type="BOX" dx="0.0" dy="0.0" dz="0.0" />
    </Block>

    <Block name="FPPB" comment="is FMS PS Pb converter"  >
      <Material name="LEAD"  />
      <Attribute for="FPPB" seen="1" colo="6"  />
      <Shape type="BOX" dx="0.0" dy="0.0" dz="0.0" />
    </Block>

    <Block name="FPSC" comment="is a piece of scintillator in FMS Preshower"  >
      <Material name="Polystyren"  />
      <Material name="FMSPS_scint" isvol="1"  />
      <Attribute for="FPSC" seen="1" colo="4" />
      <Shape type="BOX" dx="0.0" dy="0.0" dz="0.0" />
      <Par name="CUTGAM" value="0.00008" />
      <Par name="CUTELE" value="0.001"   />
      <Par name="BCUTE" value="0.0001"   />
      <Par name="BIRK1" value="1."       />
      <Par name="BIRK2" value="0.013"    />
      <Par name="BIRK3" value="9.6E-6"   />
      <Instrument block="FPSC">
	<Hit meas="birk" nbits="0" min="0" max="10" />
      </Instrument>
    </Block>

    <Block name="FLIG" comment="is a light guide + SiPM board for Preshower"  >
      <Material name="Air"  />
      <Attribute for="FLIG" seen="1" colo="6" serial="1"/>            
      <Shape type="BOX" dx="PRSW_DPRS(1)/2.0" dy="PRSW_Dz(1)/2.0+PRSW_DSIPM(1)/2.0" dz="dlg" />      
      <Create block="FLBA" />
      <Create block="FLCO" />
      <Create block="FPMT" />
      <Create block="FFEE" />
      <Placement block="FLBA" x="0" y="-PRSW_DSIPM(1)/2.0" z="PRSW_DLG(3)/2.0-dlg" /> 
      <Placement block="FLCO" x="-PRSW_DPRS(1)/4.0" y="-PRSW_DSIPM(1)/2.0" z="PRSW_DLG(3)+PRSW_DLG(2)/2.0-dlg" /> 
      <Placement block="FLCO" x="+PRSW_DPRS(1)/4.0" y="-PRSW_DSIPM(1)/2.0" z="PRSW_DLG(3)+PRSW_DLG(2)/2.0-dlg" /> 
      <Placement block="FPMT" x="0" y="-PRSW_DSIPM(1)/2.0" z="dlg-PRSW_DSIPM(1)/2.0" /> 
      <Placement block="FFEE" x="0" y="PRSW_Dz(1)/2.0" z="dlg-PRSW_DSIPM(4)/2.0" /> 
    </Block>

    <Block name="FLLG" comment="is a light guide + SiPM board for Preshower for large"  >
      <Material name="Air"  />
      <Attribute for="FLLG" seen="1" colo="6" serial="1"/>            
      <Shape type="BOX" dx="PRSW_DPRS(2)/2.0" dy="PRSW_Dz(1)/2.0+PRSW_DSIPM(1)/2.0" dz="dlg" />      
      <Create block="FBLL" />
      <Create block="FCLL" />
      <Create block="FPMT" />
      <Create block="FFEE" />
      <Placement block="FBLL" x="0" y="-PRSW_DSIPM(1)/2.0" z="PRSW_DLG(3)/2.0-dlg" /> 
      <Placement block="FCLL" x="-PRSW_DPRS(2)/4.0" y="-PRSW_DSIPM(1)/2.0" z="PRSW_DLG(3)+PRSW_DLG(2)/2-dlg" /> 
      <Placement block="FCLL" x=" PRSW_DPRS(2)/4.0" y="-PRSW_DSIPM(1)/2.0" z="PRSW_DLG(3)+PRSW_DLG(2)/2-dlg" /> 
      <Placement block="FPMT" x="0" y="-PRSW_DSIPM(1)/2.0" z="dlg-PRSW_DSIPM(1)/2.0" /> 
      <Placement block="FFEE" x="0" y="PRSW_Dz(1)/2.0" z="dlg-PRSW_DSIPM(4)/2.0" /> 
    </Block>

    <Block name="FLBA" comment="is a light guide base for Preshower"  >
      <Material name="Polystyren"  />
      <Attribute for="FLBA" seen="1" colo="4" serial="1"/>
      <Shape type="BOX" dx="PRSW_DPRS(1)/2.0" dy="PRSW_DZ(serN)/2.0" dz="PRSW_DLG(3)/2.0" />
    </Block>

    <Block name="FBLL" comment="is a light guide base for Preshower large"  >
      <Material name="Polystyren"  />
      <Attribute for="FBLL" seen="1" colo="4" serial="1"/>
      <Shape type="BOX" dx="PRSW_DPRS(2)/2.0" dy="PRSW_DZ(serN)/2.0" dz="PRSW_DLG(3)/2.0" />
    </Block>

    <Block name="FLCO" comment="is a light guide cone for Preshower"  >
      <Material name="Polystyren"  />
      <Attribute for="FLCO" seen="1" colo="4" serial="1"/>
      <Shape type="TRD2" dx1="PRSW_DPRS(1)/4.0" dx2="PRSW_DLG(1)/2.0" dy1="PRSW_DZ(serN)/2.0" dy2="PRSW_DLG(1)/2.0" dz="PRSW_DLG(2)/2.0" />
    </Block>

    <Block name="FCLL" comment="is a light guide cone for Preshower large"  >
      <Material name="Polystyren"  />
      <Attribute for="FCLL" seen="1" colo="4" serial="1"/>
      <Shape type="TRD2" dx1="PRSW_DPRS(2)/4.0" dx2="PRSW_DLG(1)/2.0" dy1="PRSW_DZ(serN)/2.0" dy2="PRSW_DLG(1)/2.0" dz="PRSW_DLG(2)/2.0" />
    </Block>

    <Block name="FPMT" comment="is a SiPM board for Preshower"  >
      <Material name="Polystyren"  />
      <Attribute for="FPMT" seen="1" colo="3" serial="1"/>
      <Shape type="BOX" dx="PRSW_DSIPM(2)/2.0" dy="PRSW_DSIPM(3)/2.0" dz="PRSW_DSIPM(1)/2.0" />
    </Block>

    <Block name="FFEE" comment="is a FEE board for Preshower"  >
      <Material name="Polystyren"  />
      <Attribute for="FEEE" seen="1" colo="3" serial="1"/>
      <Shape type="BOX" dx="PRSW_DSIPM(2)/2.0" dy="PRSW_DSIPM(1)/2.0" dz="PRSW_DSIPM(4)/2.0" />
    </Block>

    <Block name="WPPL" comment="is a pole for west platform"  >
      <Material name="Iron"  />
      <Attribute for="WPPL" seen="1" colo="4"  />
      <Shape type="BOX" dx="WPFM_PoleD(1)/2.0" dy="WPFM_PoleD(2)/2.0" dz="WPFM_PoleD(3)/2.0" />
      <Placement block="WPAR" dx="WPFM_PoleD(1)/2.0-WPFM_PoleD(4)" dy="WPFM_PoleD(2)/2.0" dz="WPFM_PoleD(3)/2.0-WPFM_PoleD(4)" 
	x="0.0" y="0.0" z="0.0" />
    </Block>

    <Block name="WPIS" comment="is a I-struct for west platform"  >
      <Material name="Iron"  />
      <Attribute for="WPIS" seen="1" colo="4"  />
      <Shape type="BOX" dx="WPFM_IstrD(1)/2.0" dy="WPFM_IstrD(2)/2.0" dz="WPFM_IstrD(3)/2.0" />
      <Placement block="WPAR" dx="WPFM_IstrD(1)/2.0" dy="WPFM_IstrD(2)/2.0-WPFM_IstrD(4)" dz="(WPFM_IstrD(3)/2.0-WPFM_IstrD(4)/2.0)/2.0" 
	x="0.0" y="0.0" z="+(WPFM_IstrD(3)/4.0-WPFM_IstrD(4)/2.0)" />
      <Placement block="WPAR" dx="WPFM_IstrD(1)/2.0" dy="WPFM_IstrD(2)/2.0-WPFM_IstrD(4)" dz="(WPFM_IstrD(3)/2.0-WPFM_IstrD(4)/2.0)/2.0" 
	x="0.0" y="0.0" z="-(WPFM_IstrD(3)/4.0-WPFM_IstrD(4)/2.0)" />
    </Block>

    <Block name="WPUF" comment="is a front U-struct for west platform"  >
      <Material name="Iron"  />
      <Attribute for="WPUF" seen="1" colo="4"  />
      <Shape type="BOX" dx="WPFM_UstFD(1)/2.0" dy="WPFM_UstFD(2)/2.0" dz="WPFM_UstFD(3)/2.0" />
      <Placement block="WPAR" dx="WPFM_UstFD(1)/2.0" dy="WPFM_UstFD(2)/2.0-WPFM_UstFD(4)" dz="WPFM_UstFD(3)/2.0-WPFM_UstFD(4)/2.0" 
	x="0.0" y="0.0" z="WPFM_UstFD(4)/2.0" />
    </Block>

    <Block name="WPUN" comment="is a north U-struct for west platform"  >
      <Material name="Iron"  />
      <Attribute for="WPUN" seen="1" colo="4"  />
      <Shape type="BOX" dx="WPFM_UstND(1)/2.0" dy="WPFM_UstND(2)/2.0" dz="WPFM_UstND(3)/2.0" />
      <Placement block="WPAR" dx="WPFM_UstND(1)/2.0-WPFM_UstND(4)/2.0" dy="WPFM_UstND(2)/2.0-WPFM_UstND(4)" dz="WPFM_UstND(3)/2.0" 
	x="+WPFM_UstND(4)/2.0" y="0.0" z="0.0" />
    </Block>

    <Block name="WPUS" comment="is a south U-struct for west platform"  >
      <Material name="Iron"  />
      <Attribute for="WPUS" seen="1" colo="4"  />
      <Shape type="BOX" dx="WPFM_UstSD(1)/2.0" dy="WPFM_UstSD(2)/2.0" dz="WPFM_UstSD(3)/2.0" />
      <Placement block="WPAR" dx="WPFM_UstSD(1)/2.0-WPFM_UstSD(4)/2.0" dy="WPFM_UstSD(2)/2.0-WPFM_UstSD(4)" dz="WPFM_UstSD(3)/2.0" 
	x="-WPFM_UstSD(4)/2.0" y="0.0" z="0.0" />
    </Block>

    <Block name="WPAR" comment="is a platform structs air"  >
      <Material name="Air"  />
      <Attribute for="WPAR" seen="1" colo="0"  />
      <Shape type="BOX" dx="0.0" dy="0.0" dz="0.0" />
    </Block>


    <!-- End of  Pre Shower -->


  </Module>


  <!-- declared already in HcalGeo.xml
  <Export language="Mortran">

    subroutine hcalhit(JJ,HIT)

    +CDE,TYPING,GCBANK,GCONST,GCUNIT,GCTMED,GCTRAK,GCKINE,GCSETS,AGCSTEP,GCVOLU.

    Integer JJ
    Real HIT,att,zhcal
    character*4 name

    call uhtoc(NAMES(NLEVEL),4,name,4)
    !write (*,*) name, nlevel

    ! activate following for fiber only
    !if(nlevel.eq.8) then        ! nlevel == 8 is fiber
    zhcal=720+117-VECT(3)        ! Also... hardcoded positions... 
    att=exp(-zhcal/220)
    !Write (*,*) name, nlevel,' z=',zhcal,' deStep = ', deStep, adestep, att
    hit = deStep * att
    !endif

    !deStep = deStep * att ! huh??
    !Write (*,*) deStep

    return
    end 

  </Export>   
  -->

</Document>

